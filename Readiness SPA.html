<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Founders Match | Readiness Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fm: {
                            boldGreen: '#D9EB31',
                            darkGreen: '#475609',
                            paleGreen: '#ECF598',
                            charcoal: '#2B2A2A',
                            mediumCharcoal: '#3E3E3E',
                            taupe: '#F8F8F8',
                            white: '#FFFFFF'
                        }
                    },
                    fontFamily: { sans: ['"Instrument Sans"', 'sans-serif'] },
                    lineHeight: { relaxed: '1.75' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Instrument Sans', sans-serif; background-color: #F8F8F8; color: #2B2A2A; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .fm-button-primary { background-color: #D9EB31; color: #2B2A2A; font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
        .fm-button-primary:hover { background-color: #ECF598; transform: translateY(-1px); }
        #tooltip { position: fixed; z-index: 9000; background-color: #2B2A2A; color: white; font-size: 0.75rem; padding: 0.75rem; border-radius: 0.375rem; max-width: 20rem; pointer-events: none; opacity: 0; transition: opacity 0.15s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        #tooltip.visible { opacity: 1; }
        .bar-transition { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        #progress-bar { width: 0%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            @page { margin: 10mm; size: A4; }
            .no-print { display: none !important; }
            nav { display: none !important; }
            .print-container { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; border: none !important; }
            .print-break-inside { break-inside: avoid; page-break-inside: avoid; }
            .print-break-before { break-before: page; page-break-before: always; }
            .protocol-card { break-inside: avoid; page-break-inside: avoid; display: block; margin-bottom: 20px; }
            #core-grid { display: block !important; }
            .accordion-content { max-height: none !important; opacity: 1 !important; display: block !important; overflow: visible !important; }
            .accordion-btn { display: none !important; }
        }
        .accordion-content { transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-content.open { max-height: 1200px; opacity: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans leading-relaxed">

    <!-- GLOBAL STORAGE BRIDGE — defined first so all sections can use it -->
    <script>
        // Pure in-memory submissions store — works in all environments
        window._submissionsStore = [];

        window.saveSubmission = async function(submission) {
            window._submissionsStore.unshift(submission);
            // Also try persistent storage if available
            try {
                if (window.storage && window.storage.set) {
                    await window.storage.set('fm_submissions', JSON.stringify(window._submissionsStore));
                }
            } catch(e) { /* silent — in-memory is the source of truth */ }
        };

        window.loadSubmissions = async function() {
            // Try to hydrate from persistent storage once
            if (!window._storageLoaded) {
                window._storageLoaded = true;
                try {
                    if (window.storage && window.storage.get) {
                        const result = await window.storage.get('fm_submissions');
                        if (result && result.value) {
                            const persisted = JSON.parse(result.value);
                            // Merge persisted into in-memory without duplicates
                            const existingIds = new Set(window._submissionsStore.map(s => s.id));
                            persisted.forEach(s => { if (!existingIds.has(s.id)) window._submissionsStore.push(s); });
                        }
                    }
                } catch(e) { /* no persisted data yet — fine */ }
            }
            return window._submissionsStore;
        };

        window.openReportForSubmission = function(submission) {
            if (typeof processJsonData === 'function') {
                processJsonData(submission);
                switchView('Assessment-Report');
            }
        };

        // SPA navigation
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-fm-charcoal');
                btn.classList.add('text-fm-mediumCharcoal');
            });
            const activeBtn = document.getElementById('nav-' + viewId);
            if (activeBtn) {
                activeBtn.classList.remove('text-fm-mediumCharcoal');
                activeBtn.classList.add('bg-white', 'shadow-sm', 'text-fm-charcoal');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
            if (typeof lucide !== 'undefined') lucide.createIcons();
            if (viewId === 'Assessment-Admin' && typeof window.refreshAdminData === 'function') {
                window.refreshAdminData();
            }
        }
    </script>

    <!-- NAV -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 flex items-center justify-center bg-fm-charcoal rounded-sm text-white">
                    <i data-lucide="arrow-up-right" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-xl tracking-tight text-fm-charcoal">Founders Match</span>
            </div>
            <div class="flex items-center space-x-2 bg-fm-taupe p-1 rounded-lg border border-gray-200">
                <button onclick="switchView('Assessment')" id="nav-Assessment" class="nav-btn active px-4 py-2 text-sm font-medium rounded-md text-fm-charcoal bg-white shadow-sm transition-all">Assessment</button>
                <button onclick="switchView('Assessment-Admin')" id="nav-Assessment-Admin" class="nav-btn px-4 py-2 text-sm font-medium rounded-md text-fm-mediumCharcoal hover:text-fm-charcoal transition-all">Admin</button>
                <button onclick="switchView('Assessment-Report')" id="nav-Assessment-Report" class="nav-btn px-4 py-2 text-sm font-medium rounded-md text-fm-mediumCharcoal hover:text-fm-charcoal transition-all">Report</button>
            </div>
        </div>
    </nav>

    <main class="flex-1 w-full max-w-7xl mx-auto px-6 py-12 relative">

        <!-- ================================================================ -->
        <!-- ASSESSMENT VIEW                                                   -->
        <!-- ================================================================ -->
        <div id="Assessment" class="view-section active w-full">
    <div id="tooltip"></div>
    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8 border-b border-fm-slate200 pb-6">
            <div class="flex items-center gap-4">
                <div class="text-base font-bold tracking-tight">Founders Match <span class="text-slate-400 font-normal">| Readiness assessment</span></div>
                <div class="relative ml-4">
                    <label for="currency-selector" class="text-xs font-bold text-slate-400 mr-2">Currency:</label>
                    <select id="currency-selector" onchange="app.setCurrency(this.value)" class="text-xs font-bold bg-white border border-slate-200 rounded px-2 py-1 text-fm-charcoal focus:outline-none focus:border-fm-darkGreen cursor-pointer">
                        <option value="£">GBP (£)</option>
                        <option value="€">EUR (€)</option>
                        <option value="$">USD ($)</option>
                    </select>
                </div>
            </div>
            <button onclick="app.resetAll()" class="text-xs font-bold text-slate-400 hover:text-red-600 transition-colors border border-slate-200 px-4 py-2 rounded bg-white">Reset data</button>
        </div>

        <!-- Entity Verification -->
        <section class="bg-white rounded-xl border border-slate-200 shadow-sm p-8 mb-8">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-lg font-bold">Entity verification</h2>
                    <p class="text-sm text-slate-500">Confirm legal jurisdiction and status.</p>
                </div>
                <span class="bg-slate-100 text-slate-500 text-[10px] uppercase font-bold px-3 py-1 rounded">Step 1 of 3</span>
            </div>
            <div class="grid md:grid-cols-4 gap-6 mb-6">
                <div class="space-y-2">
                    <label class="text-xs font-bold uppercase">Registered name</label>
                    <input type="text" id="regName" placeholder="e.g. Acme Innovations Ltd" class="w-full text-sm border border-slate-300 rounded p-3 focus:border-fm-darkGreen focus:ring-1 focus:ring-fm-darkGreen focus:outline-none transition-colors">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold uppercase">Country of registration</label>
                    <div class="relative" id="country-dropdown-container">
                        <button type="button" onclick="app.toggleCountryDropdown(event)" id="country-btn" class="w-full text-sm border border-slate-300 rounded p-3 bg-white focus:border-fm-darkGreen focus:outline-none cursor-pointer flex justify-between items-center text-left">
                            <span id="country-selected-text">United Kingdom</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                        </button>
                        <div id="country-menu" class="absolute z-50 w-full top-full mt-1 bg-white border border-slate-200 rounded shadow-lg max-h-60 overflow-y-auto hidden"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold uppercase">Registration no.</label>
                    <input type="text" id="regNo" placeholder="e.g. 12345678" class="w-full text-sm border border-slate-300 rounded p-3 focus:border-fm-darkGreen focus:outline-none transition-colors">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold uppercase">Website</label>
                    <input type="url" id="website" placeholder="https://" class="w-full text-sm border border-slate-300 rounded p-3 focus:border-fm-darkGreen focus:outline-none transition-colors">
                </div>
            </div>
            <div class="grid md:grid-cols-4 gap-6 mb-6">
                <div class="md:col-span-2 space-y-2"><label class="text-xs font-bold uppercase">Address line 1</label><input type="text" id="addr1" placeholder="Street address" class="w-full text-sm border border-slate-300 rounded p-3 focus:border-fm-darkGreen focus:outline-none transition-colors"></div>
                <div class="md:col-span-2 space-y-2"><label class="text-xs font-bold uppercase">Address line 2</label><input type="text" id="addr2" placeholder="Apartment, suite, unit (optional)" class="w-full text-sm border border-slate-300 rounded p-3 focus:border-fm-darkGreen focus:outline-none transition-colors"></div>
                <div class="space-y-2"><label class="text-xs font-bold uppercase">City</label><input type="text" id="city" placeholder="City" class="w-full text-sm border border-slate-300 rounded p-3 focus:border-fm-darkGreen focus:outline-none transition-colors"></div>
                <div class="space-y-2"><label class="text-xs font-bold uppercase">County / State</label><input type="text" id="state" placeholder="Region" class="w-full text-sm border border-slate-300 rounded p-3 focus:border-fm-darkGreen focus:outline-none transition-colors"></div>
                <div class="space-y-2"><label class="text-xs font-bold uppercase">Postcode / ZIP</label><input type="text" id="zip" placeholder="Postcode" class="w-full text-sm border border-slate-300 rounded p-3 focus:border-fm-darkGreen focus:outline-none transition-colors"></div>
            </div>
            <div class="mt-6 border-t border-slate-200 pt-6">
                <label class="text-xs font-bold uppercase mb-3 block">Supporting documentation</label>
                <button id="btn-doc_incorp" onclick="app.handleUpload('doc_incorp')" class="px-6 py-3 rounded text-xs font-mono flex items-center gap-2 w-full md:w-auto justify-center transition-all border border-dashed border-slate-300 bg-fm-taupe text-slate-500 hover:bg-white hover:border-fm-darkGreen"></button>
            </div>
        </section>

        <main class="grid lg:grid-cols-12 gap-8">
            <!-- Left: Visualization -->
            <div class="lg:col-span-4 space-y-6">
                <section class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 sticky top-8 flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Assessment profile</h2>
                        <div id="tier-badge" class="px-3 py-1 rounded-sm font-bold text-xs border transition-all"></div>
                    </div>
                    <div class="chart-container mb-5 flex-shrink-0 flex justify-center">
                        <div id="radar-chart" class="w-full max-w-[250px] aspect-square mx-auto"></div>
                    </div>
                    <div class="space-y-6 border-t border-slate-200 pt-6 flex-grow">
                        <div>
                            <div class="flex justify-between text-xs font-bold text-fm-charcoal mb-2">
                                <span>Readiness index</span><span id="progress-text">0%</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                <div id="progress-bar" class="bg-fm-boldGreen h-full rounded-full bar-transition"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Specialist badges</h3>
                            <div id="badges-container" class="grid grid-cols-2 gap-2"></div>
                        </div>
                        <div id="sector-badges-wrapper" class="hidden border-t border-slate-200 pt-6">
                            <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Sector badges earned</h3>
                            <div id="sector-badges-container" class="grid grid-cols-1 gap-2"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right: Assessment Fields -->
            <div class="lg:col-span-8 space-y-6">
                <section class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
                        <div class="flex items-center gap-3">
                            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Core protocol</h2>
                            <span id="slide-counter" class="text-xs font-bold text-fm-charcoal bg-slate-100 px-2 py-0.5 rounded-full">1 / 5</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" onclick="app.changeSlide(-1)" class="p-2 rounded border border-slate-200 hover:bg-slate-50 text-fm-charcoal transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                            </button>
                            <button type="button" onclick="app.changeSlide(1)" class="p-2 rounded border border-slate-200 hover:bg-slate-50 text-fm-charcoal transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                            </button>
                        </div>
                    </div>
                    <div id="protocol-container" class="min-h-[400px]"></div>
                </section>

                <section class="bg-fm-charcoal rounded-xl border border-slate-800 shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-700">
                        <h2 class="text-xs font-bold text-slate-300 uppercase tracking-widest mb-3">Sector modules</h2>
                        <div id="sector-tabs" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div id="sector-items" class="p-6 space-y-4"></div>
                </section>

                <div class="flex justify-end gap-3 pb-8">
                    <button onclick="app.downloadAssessment()" class="text-xs font-bold bg-white text-fm-charcoal border border-slate-300 px-5 py-2.5 rounded hover:bg-slate-50 transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Export JSON
                    </button>
                    <button onclick="app.submitAssessment()" class="text-xs font-bold bg-fm-boldGreen text-fm-darkGreen border border-fm-darkGreen px-6 py-2.5 rounded hover:bg-fm-darkGreen hover:text-white transition-colors flex items-center gap-2 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                        Submit Assessment
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ICONS — defined globally on window so all view scripts can access them
        window.ICONS = {
            building: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21V7a2 2 0 012-2h4V3h6v2h4a2 2 0 012 2v14M9 21v-6h6v6"/></svg>`,
            shield: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
            zap: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
            zapSm: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
            globe: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" stroke-linejoin="round" d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>`,
            users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path stroke-linecap="round" stroke-linejoin="round" d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>`,
            activity: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
            briefcase: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>`,
            lock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M7 11V7a5 5 0 0110 0v4"/></svg>`,
            trending: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>`,
            check: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>`,
            alert: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>`,
            info: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`,
            upload: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>`
        };
        const ICONS = window.ICONS;

        const REGISTRY_INFO = {
            uk:       { label: 'Companies House number (e.g. 12345678)', doc: 'Certificate of Incorporation' },
            fr:       { label: 'SIREN / SIRET number', doc: 'Kbis Extract' },
            de:       { label: 'Handelsregisternummer (HRB/HRA)', doc: 'Handelsregisterauszug' },
            gr:       { label: 'GEMI registration number', doc: 'Certificate of Registration' },
            is:       { label: 'RSK / company registration number', doc: 'Certificate of Incorporation' },
            ie:       { label: 'CRO company number', doc: 'Certificate of Incorporation' },
            it:       { label: 'Codice fiscale / REA number', doc: 'Visura Camerale' },
            lv:       { label: 'Uzņēmumu reģistra number', doc: 'Certificate of Registration' },
            lu:       { label: 'RCS Luxembourg number', doc: 'Extrait RCS' },
            nl:       { label: 'KvK number', doc: 'KvK Uittreksel' },
            se:       { label: 'Organisationsnummer', doc: 'Registreringsbevis' },
            es:       { label: 'CIF / NIF number', doc: 'Certificado de inscripción' },
            eu_other: { label: 'National company registration number', doc: 'Certificate of Incorporation' },
        };

        const CORE_DIMENSIONS = [
            { id: 1, title: 'Corporate structure', icon: ICONS.building, desc: 'Foundational legal and financial stability.', rationale: 'Is the entity robust enough to survive the sales cycle?', items: [
                // --- REQUIRED SECTION ---
                { id: 'incorp_status', type: 'tiles', question: 'Incorporation Status', required: true, weight: 0.1, doc: 'Cert of Inc.', docId: 'doc_incorp', why: 'Ensures the business is a distinct legal entity to limit corporate liability.', options: [{l: 'Ltd', v: 1}, {l: 'Inc', v: 1}, {l: 'GmbH', v: 1}, {l: 'SAS', v: 1}, {l: 'PLC', v: 1}] },
                { id: 'beneficial_ownership', type: 'text', question: 'Beneficial Ownership (KYC)', required: true, weight: 0.09, doc: 'KYC Disclosure', docId: 'doc_kyc', why: 'Mandatory verification of control to meet 2026 anti-money laundering standards.' },
                { id: 'dir_id_verified', type: 'checkbox', question: 'Verified Identity for Directors & PSCs', required: true, weight: 0.09, doc: 'ID Verification Proof', docId: 'doc_id_v', why: '2026 UK legal mandate requiring ID verification for all directors and significant owners.' },
                { id: 'ip_assignment', type: 'checkbox', question: 'IP Assignment (PIIAA)', required: true, weight: 0.09, doc: 'IP Assignment Agmt', docId: 'doc_ip_piiaa', why: 'Verified that all code and designs built by founders/contractors are legally owned by the company.' },
                { id: 'registered_office', type: 'tiles', question: 'Registered Office', required: true, weight: 0.09, doc: 'Proof of Address', docId: 'doc_office_proof', why: 'Proof of a physical business presence to satisfy "real business" verification protocols.', options: [{l: 'Real Office', v: 1}, {l: 'PO Box', v: 0.2}] },
                { id: 'pi_limit', type: 'tiles', question: 'Professional indemnity limit', required: true, weight: 0.09, doc: 'Insurance Schedule', docId: 'doc_ins_pi', why: 'Absolute contractual floor required to satisfy Enterprise MSA liability caps.', options: [{l: 'None', v: 0}, {l: '<£1m', v: 0.5}, {l: '£1m+', v: 1}] },
                
                // --- OPTIONAL SECTION ---
                { id: 'ai_accountability', type: 'text', question: 'AI Accountability Owner', required: false, weight: 0.45, doc: 'AI Charter', docId: 'doc_ai_owner', why: 'Advanced 2026 governance; a specific role must be accountable for AI compliance and risk.' },
                { id: 'board_of_directors', type: 'text', question: 'Board of Directors', required: false, weight: 0.45, doc: 'Board List', docId: 'doc_board', why: 'Independent oversight signals organizational stability and de-risks key-person dependency.' },
                { id: 'ip_indemnity_3rd_party', type: 'checkbox', question: 'Indemnity for 3rd-Party IP Claims', required: false, weight: 0.45, doc: 'MSA Template', docId: 'doc_ip_indem', why: 'The ultimate legal differentiator; a promise that your software does not infringe on existing patents.' },
                { id: 'founder_vesting', type: 'checkbox', question: 'Founder/Key-Person Vesting', required: false, weight: 0.45, doc: 'Shareholders Agmt', docId: 'doc_vesting', why: 'Protects the corporate client from project abandonment if a founder departs early.' },
                { id: 'authority_matrix', type: 'checkbox', question: 'Authority Matrix', required: false, weight: 0.45, doc: 'RACI Matrix', docId: 'doc_raci', why: 'Documented rules on contract signing and spend to prevent project integration stalling.' },
                { id: 'independent_directors', type: 'tiles', question: 'Independent Director Rep.', required: false, weight: 0.45, doc: 'Director CVs', docId: 'doc_indep_dir', why: 'Independent directors provide unbiased oversight and increase professionalism scores.', options: [{l: '0', v: 0}, {l: '1', v: 0.5}, {l: '2+', v: 1}] },
                { id: 'board_committees', type: 'multi', question: 'Board Committee Structure', required: false, weight: 0.45, doc: 'Committee Charters', docId: 'doc_committees', why: 'Mirroring corporate setups (Audit/Risk) demonstrates high governance maturity.' },
                { id: 'cap_table_clarity', type: 'tiles', question: 'Cap Table Clarity', required: false, weight: 0.45, doc: 'Cap Table Summary', docId: 'doc_cap_table', why: 'Messy ownership structures are major red flags that often stall procurement.', options: [{l: 'Clear', v: 1}, {l: 'Disputed', v: 0}] },
                { id: 'operating_history', type: 'tiles', question: 'Operating History', required: false, weight: 0.45, doc: 'Registration Proof', docId: 'doc_op_hist', why: 'Corporates look for a 2+ year track record to avoid shell company risk.', options: [{l: '0-1 yr', v: 0.2}, {l: '1-2 yr', v: 0.5}, {l: '2-5 yr', v: 0.8}, {l: '5+ yr', v: 1}] },
                { id: 'trading_duration', type: 'tiles', question: 'How long trading?', required: false, weight: 0.45, doc: 'Financial Proof', docId: 'doc_trading', why: 'Specifically assesses active trading time to mitigate insolvency risk.', options: [{l: '<1 yr', v: 0.2}, {l: '1-2 yr', v: 0.6}, {l: '2+ yr', v: 1}] },
                { id: 'parent_subsidiary', type: 'tiles', question: 'Parent-Subsidiary Relationship', required: false, weight: 0.45, doc: 'Structure Chart', docId: 'doc_parent_sub', why: 'Ensures clear understanding of where the contract lies and where IP is held.', options: [{l: 'Single', v: 1}, {l: 'Group', v: 1}] },
                { id: 'holding_setup', type: 'tiles', question: 'Subsidiary/Holding Setup', required: false, weight: 0.45, doc: 'Group Map', docId: 'doc_holding', why: 'Identifies if IP is ring-fenced, affecting the client’s long-term licensing security.', options: [{l: 'Single', v: 1}, {l: 'Holding-OpCo', v: 1}] },
                { id: 'cross_border_compliance', type: 'checkbox', question: 'Cross-Border Compliance', required: false, weight: 0.45, doc: 'Legal Structure', docId: 'doc_cross_border', why: 'Ensures non-UK/US entities are properly declared for tax and international regulatory risk.' },
                { id: 'employee_contractor_ratio', type: 'text', question: 'Employee vs. Contractor Ratio', required: false, weight: 0.45, doc: 'HR Summary', docId: 'doc_hr_ratio', why: 'Identifies misclassified contractors to avoid the client’s joint-employer tax liabilities.' },
                { id: 'chain_of_title', type: 'checkbox', question: 'Chain of Title (IP) Warranty', required: false, weight: 0.45, doc: 'PIIAA Audit', docId: 'doc_ip_warranty', why: 'A formal guarantee that the chain of ownership for all code is unbroken from inception.' },
                { id: 'authorized_filing_agent', type: 'checkbox', question: 'Authorised Filing Agent Used?', required: false, weight: 0.45, doc: 'Agent Verification', docId: 'doc_filing_agent', why: 'In 2026, using an authorized agent for filings is a proxy for high-trust administration.' },
                { id: 'cap_table_clean', type: 'checkbox', question: 'Cap table clean & assigned?', required: false, weight: 0.45, doc: 'Cap Table', docId: 'doc_cap_clean', why: 'Simplified verification that all equity promises are documented to prevent litigation.' },
                { id: 'board_esg_oversight', type: 'checkbox', question: 'Board-Level ESG Oversight', required: false, weight: 0.45, doc: 'Board Charter', docId: 'doc_esg_oversight', why: 'Proof of formal accountability at the highest level, signaling ESG is a strategic priority.' },
                { id: 'dei_policy', type: 'checkbox', question: 'Formal DE&I policy?', required: false, weight: 0.45, doc: 'HR Handbook', docId: 'doc_dei_policy', why: 'Aligns with corporate supplier codes of conduct regarding diversity and inclusion.' },
                { id: 'gender_pay_gap', type: 'text', question: 'Gender Pay Gap Percentage', required: false, weight: 0.45, doc: 'Pay Gap Report', docId: 'doc_pay_gap', why: 'Benchmark for equity; required by EU directive for firms reaching certain scale thresholds.' },
                { id: 'executive_esg_linkage', type: 'checkbox', question: 'Executive ESG Linkage', required: false, weight: 0.45, doc: 'Remuneration Pol.', docId: 'doc_esg_link', why: 'Links leadership remuneration to the achievement of sustainability goals.' }
            ]},
            { id: 2, title: 'Security & compliance', icon: ICONS.shield, desc: 'Data protection and infiltration risk.', rationale: 'Can we trust you with our customer data?', items: [
                // --- REQUIRED SECTION ---
                { id: 'modern_slavery_policy', type: 'checkbox', question: 'Modern Slavery & Human Rights Policy', required: true, weight: 0.05, doc: 'Written Policy', docId: 'doc_ms_policy', why: 'Mandatory legal hurdle to prevent human rights violations in the supply chain.' },
                { id: 'privacy_policy', type: 'checkbox', question: 'Privacy policy', required: true, weight: 0.05, doc: 'Privacy Policy', docId: 'doc_privacy_pol', why: 'Absolute legal mandate under GDPR/UK GDPR for any entity processing personal data.' },
                { id: 'data_encryption', type: 'checkbox', question: 'Data encrypted rest & transit?', required: true, weight: 0.05, doc: 'Arch Diagram', docId: 'doc_encrypt_proof', why: 'Fundamental security control; non-negotiable for enterprise data protection.' },
                { id: 'dr_tested', type: 'checkbox', question: 'Disaster recovery tested?', required: true, weight: 0.05, doc: 'DR Plan', docId: 'doc_dr_test', why: 'Base-level reliability requirement to ensure business continuity and minimize data loss.' },
                { id: 'dpa_ready', type: 'checkbox', question: 'Data Processing Agmt (DPA)', required: true, weight: 0.05, doc: 'DPA Template', docId: 'doc_dpa_template', why: 'Legal necessity defining sub-processors; must be ready to sign during onboarding.' },
                { id: 'tax_good_standing', type: 'checkbox', question: 'Tax Good Standing Certificate', required: true, weight: 0.05, doc: 'Tax Status Letter', docId: 'doc_tax_cert', why: 'Proves the entity is current on tax obligations to avoid financial liens.' },
                { id: 'right_to_work', type: 'tiles', question: 'Right to Work Verification', required: true, weight: 0.05, doc: 'Verification Policy', docId: 'doc_rtw_proof', why: 'Mandatory legal requirement to prevent illegal employment risks.', options: [{l: '100%', v: 1}, {l: '<100%', v: 0}] },
                { id: 'abc_policy', type: 'checkbox', question: 'Anti-Bribery & Corruption (ABC)', required: true, weight: 0.05, doc: 'ABC Policy', docId: 'doc_abc_policy', why: 'Non-negotiable requirement under the UK Bribery Act and FCPA.' },
                { id: 'ip_indemnity_3rd', type: 'checkbox', question: 'Indemnity for 3rd-Party IP', required: true, weight: 0.05, doc: 'MSA Template', docId: 'doc_ip_indem_sec', why: 'Contractual floor: a guarantee that your software doesn’t infringe on existing patents.' },
                { id: 'data_residency_loc', type: 'multi', question: 'Tech Stack Location (Data Residency)', required: true, weight: 0.05, doc: 'Architecture Diagram', docId: 'doc_residency_map', why: 'Ensures compliance with GDPR and jurisdictional sovereignty laws.', options: [{l: 'UK', v: 1}, {l: 'EU', v: 1}, {l: 'US', v: 1}, {l: 'APAC', v: 1}] },
                { id: 'cloud_provider', type: 'multi', question: 'Cloud Infrastructure Provider', required: true, weight: 0.05, doc: 'Service Summary', docId: 'doc_cloud_prov', why: 'Identifies systemic provider risk and determines ESG reporting capability.', options: [{l: 'AWS', v: 1}, {l: 'Azure', v: 1}, {l: 'GCP', v: 1}, {l: 'On-Prem', v: 1}] },
                
                // --- OPTIONAL SECTION ---
                { id: 'abc_training_pct', type: 'text', question: 'Anti-Corruption & Bribery Training', required: false, weight: 0.48, doc: 'Training Register', docId: 'doc_abc_train', why: 'Fundamental ethical compliance requirement for large corporate ecosystems.' },
                { id: 'whistleblowing_chan', type: 'checkbox', question: 'Whistleblowing Channels', required: false, weight: 0.48, doc: 'Grievance Policy', docId: 'doc_whistle_chan', why: 'Documents mechanisms to report ethical malpractices anonymously.' },
                { id: 'isms_type', type: 'tiles', question: 'ISMS cert (SOC2 / ISO)', required: false, weight: 0.48, doc: 'Audit Report', docId: 'doc_isms_cert', why: 'Signals a mature, independently verified management system.', options: [{l: 'Cyber Essentials', v: 0.4}, {l: 'ISO', v: 0.9}, {l: 'SOC2', v: 1}] },
                { id: 'pen_test_freq', type: 'tiles', question: 'Penetration testing', required: false, weight: 0.48, doc: 'Test Summary', docId: 'doc_pentest', why: 'Proactive verification; proves defenses work against current real-world exploits.', options: [{l: '<12 mo', v: 1}, {l: '>12 mo', v: 0.4}] },
                { id: 'scim_deprovision', type: 'checkbox', question: 'Automated Deprovisioning (SCIM)', required: false, weight: 0.48, doc: 'SCIM Docs', docId: 'doc_scim', why: 'Prevents "orphan accounts" when client employees depart the firm.' },
                { id: 'saml_oidc_support', type: 'checkbox', question: 'SAML 2.0 / OIDC Support', required: false, weight: 0.47, doc: 'Integration Guide', docId: 'doc_sso_spec', why: 'Primary maturity indicator for identity security; allows client IDP management.' },
                { id: 'adaptive_mfa', type: 'checkbox', question: 'Adaptive MFA Implementation', required: false, weight: 0.47, doc: 'Auth Policy', docId: 'doc_mfa_policy', why: 'Applies MFA based on risk signals, balancing security and UX.' },
                { id: 'immutable_logs', type: 'checkbox', question: 'Immutable Audit Logs', required: false, weight: 0.47, doc: 'Log Config', docId: 'doc_logs_audit', why: 'Ensures logs are tamper-proof and retained for 1yr+ per 2026 standards.' },
                { id: 'pii_redaction', type: 'checkbox', question: 'PII Redaction in Logs', required: false, weight: 0.47, doc: 'Sample Log', docId: 'doc_pii_redact', why: 'Privacy-first engineering: ensures sensitive data isn’t stored in plaintext.' },
                { id: 'net_segregation', type: 'checkbox', question: 'Network Segregation', required: false, weight: 0.47, doc: 'Architecture Map', docId: 'doc_net_seg', why: 'Prevents "lateral movement"; isolates production data from development.' },
                { id: 'patch_window', type: 'tiles', question: 'Vulnerability Patch Window', required: false, weight: 0.47, doc: 'Patch Policy', docId: 'doc_patch_mgmt', why: 'Aligns with Cyber Essentials 2026 mandate for 14-day high-risk patching.', options: [{l: '<14 Days', v: 1}, {l: '<30 Days', v: 0.5}] },
                { id: 'sbom_export', type: 'checkbox', question: 'Software Bill of Materials (SBOM)', required: false, weight: 0.47, doc: 'SBOM Export', docId: 'doc_sbom', why: 'Tracks open-source libraries to manage cascading security vulnerabilities.' },
                { id: 'incident_test_freq', type: 'tiles', question: 'Incident Response Testing', required: false, weight: 0.47, doc: 'Test Report', docId: 'doc_ir_test', why: 'Verification that your team has "fire-drilled" breach notifications.', options: [{l: 'Annually', v: 0.7}, {l: 'Quarterly', v: 1}] },
                { id: 'nis2_dora_scope', type: 'tiles', question: 'NIS2 / DORA Scope Check', required: false, weight: 0.47, doc: 'Compliance Rationale', docId: 'doc_scope_check', why: 'Determines if the startup is subject to 2026 EU mandates.', options: [{l: 'In Scope', v: 1}, {l: 'Out of Scope', v: 1}] },
                { id: 'export_control_review', type: 'tiles', question: 'Export Control Review', required: false, weight: 0.47, doc: 'Compliance Memo', docId: 'doc_export_review', why: 'Vital for dual-use tech; identifies ITAR, EAR, or AI restrictions.', options: [{l: 'In Scope', v: 1}, {l: 'Out of Scope', v: 1}] },
                { id: 'transfer_pricing', type: 'tiles', question: 'Transfer Pricing Policy', required: false, weight: 0.47, doc: 'OECD Report', docId: 'doc_transfer_pricing', why: 'High-maturity tax check to ensure margins align with OECD 2026 guidelines.', options: [{l: 'Yes', v: 1}, {l: 'No', v: 0}, {l: 'N/A', v: 1}] }    
            ]},
            { id: 3, title: 'AI governance', icon: ICONS.zap, desc: 'Managing "black box" liability.', rationale: 'Can you explain the AI decisions?', items: [
                // --- REQUIRED SECTION ---
                { id: 'ai_act_tier', type: 'tiles', question: 'AI Act compliance tier?', required: true, weight: 0.3, doc: 'Compliance Roadmap', docId: 'doc_ai_tier', why: 'Mandatory legal classification for the 2026 deadline.', options: [{l: 'Unregulated', v: 1}, {l: 'Class I', v: 1}, {l: 'Class II', v: 1}, {l: 'Prohibited', v: 0}] },
                { id: 'ai_risk_class', type: 'tiles', question: 'AI Act Risk Classification?', required: true, weight: 0.3, doc: 'Compliance Roadmap', docId: 'doc_ai_risk', why: 'Secondary verification of specific risk category.', options: [{l: 'Unregulated', v: 1}, {l: 'Limited', v: 1}, {l: 'High-Risk', v: 1}, {l: 'Prohibited', v: 0}] },
                { id: 'prohibited_check', type: 'checkbox', question: 'Prohibited Practice Check?', required: true, weight: 0.3, doc: 'Article 5 Attestation', docId: 'doc_ai_prohib', why: 'Verified absence of social scoring or manipulative AI.' },
                { id: 'disclosure_process', type: 'checkbox', question: 'AI System Disclosure process?', required: true, weight: 0.3, doc: 'UI Screenshots', docId: 'doc_ai_discl', why: 'Mandatory transparency; synthetic content and bots must be clearly labeled.' },
                
                // --- OPTIONAL SECTION ---
                { id: 'hold_training_data', type: 'checkbox', question: 'Hold training data?', required: false, weight: 0.88, doc: 'Data audit log', docId: 'doc_train_data', why: 'Demonstrates control over the supply chain for deep technical due diligence.' },
                { id: 'data_provenance', type: 'text', question: 'Training Data Provenance?', required: false, weight: 0.88, doc: 'Data audit log', docId: 'doc_provenance', why: 'Proves data was legally sourced, protecting against copyright claims.' },
                { id: 'data_quality_asmnt', type: 'tiles', question: 'Data Quality Assessment?', required: false, weight: 0.88, doc: 'Quality Report', docId: 'doc_data_qual', why: 'Ensures data is representative and error-free to prevent model drift.', options: [{l: 'High', v: 1}, {l: 'Medium', v: 0.6}, {l: 'Low', v: 0.2}] },
                { id: 'bias_protocols', type: 'checkbox', question: 'Bias Testing Protocols?', required: false, weight: 0.88, doc: 'Bias Audit Log', docId: 'doc_bias_test', why: 'Proactive detection of algorithmic discrimination.' },
                { id: 'model_cards', type: 'checkbox', question: 'Model Cards Documented?', required: false, weight: 0.88, doc: 'Tech Documentation', docId: 'doc_model_cards', why: 'Moves beyond "black box" claims by detailing architecture and training limits.' },
                { id: 'human_oversight', type: 'tiles', question: 'Human Oversight Model?', required: false, weight: 0.88, doc: 'Oversight Policy', docId: 'doc_oversight', why: 'Defines intervention strategy (HITL/HOTL) to mitigate autonomous errors.', options: [{l: 'HITL', v: 1}, {l: 'HOTL', v: 0.7}, {l: 'HIC', v: 0.4}] },
                { id: 'stop_button', type: 'checkbox', question: '"Stop Button" Protocol?', required: false, weight: 0.88, doc: 'Incident Plan', docId: 'doc_stop_button', why: 'Critical safety mechanism to halt operations during failure.' },
                { id: 'ai_incident_plan', type: 'checkbox', question: 'AI Incident Response plan?', required: false, weight: 0.88, doc: 'Incident Log Template', docId: 'doc_ai_incident', why: 'Workflow for reporting serious incidents within 24 hours.' },
                { id: 'ai_ip_indemnity', type: 'checkbox', question: 'IP Indemnity Offered?', required: false, weight: 0.88, doc: 'Legal Terms', docId: 'doc_ai_indemnity', why: 'Legal differentiator; shifts copyright risk away from the client.' },
                { id: 'explainability', type: 'tiles', question: 'Explainability Level?', required: false, weight: 0.88, doc: 'Explainability Doc', docId: 'doc_explain', why: 'Provides logical justification for automated outputs.', options: [{l: 'Global', v: 1}, {l: 'Local', v: 0.8}, {l: 'None', v: 0}] }
            ]},
            { id: 4, title: 'Commercial readiness', icon: ICONS.users, desc: 'Navigating enterprise procurement.', rationale: 'Can you sign our MSA?', items: [
                // --- REQUIRED SECTION ---
                { id: 'arr_revenue', type: 'tiles', question: 'Annual Recurring Revenue (ARR)', required: true, weight: 0.3, doc: 'Management Accounts', docId: 'doc_arr_stmt', why: 'Baseline financial evidence to ensure the startup is a viable ongoing concern.', options: [{l: '<£100k', v: 0.3}, {l: '£100k-£1M', v: 0.7}, {l: '£1M+', v: 1}] },
                { id: 'runway_months', type: 'tiles', question: 'Runway (Months)', required: true, weight: 0.3, doc: 'Financial Statement', docId: 'doc_runway_stmt', why: 'Assurance the startup will exist for the duration of the pilot and rollout.', options: [{l: '<6', v: 0}, {l: '6-12', v: 0.4}, {l: '12-18', v: 0.8}, {l: '18+', v: 1}] },
                { id: 'liability_cap', type: 'tiles', question: 'Contractual liability cap', required: true, weight: 0.3, doc: 'Insurance schedule', docId: 'doc_ins_cap', why: 'Matches startup risk profile with corporate indemnity requirements.', options: [{l: '<£1m', v: 0.3}, {l: '£1m-£5m', v: 0.7}, {l: '£5m+', v: 1}] },
                { id: 'ent_terms_ready', type: 'checkbox', question: 'Standard Enterprise Terms', required: true, weight: 0.3, doc: 'MSA/SaaS Template', docId: 'doc_msa_template', why: 'Ready-to-sign contract framework prevents procurement stalling.' },
                
                // --- OPTIONAL SECTION ---
                { id: 'ent_references', type: 'tiles', question: 'Enterprise references', required: false, weight: 0.88, doc: 'Reference List', docId: 'doc_ref_list', why: 'The primary currency of trust; social proof from similar large organizations.', options: [{l: 'None', v: 0}, {l: '1', v: 0.4}, {l: '2', v: 0.7}, {l: '3+', v: 1}] },
                { id: 'ent_cust_count', type: 'tiles', question: 'Enterprise Customer Count', required: false, weight: 0.88, doc: 'Logo Sheet', docId: 'doc_logo_sheet', why: 'Ability to navigate large organizational complexity; 3+ logos is the benchmark.', options: [{l: '0', v: 0}, {l: '1', v: 0.4}, {l: '2', v: 0.7}, {l: '3+', v: 1}] },
                { id: 'pmf_evidence', type: 'text', question: 'Product-Market Fit Evidence', required: false, weight: 0.88, doc: 'Metrics Report', docId: 'doc_pmf_metrics', why: 'Hard metrics (NPS/Retention) demonstrating that existing enterprise users find value.' },
                { id: 'pilot_track_record', type: 'text', question: 'Pilot Track Record', required: false, weight: 0.88, doc: 'Pilot Outcomes', docId: 'doc_pilot_log', why: 'Evidence of successful transitions from a pilot state to a full production contract.' },
                { id: 'std_rate_card', type: 'checkbox', question: 'Standard rate card?', required: false, weight: 0.88, doc: 'Pricing Sheet', docId: 'doc_pricing_card', why: 'Demonstrates pricing maturity and prevents individual deal negotiation delays.' },
                { id: 'gtm_plan', type: 'tiles', question: 'Go-to-Market (GTM) Plan', required: false, weight: 0.88, doc: 'GTM Strategy', docId: 'doc_gtm_strat', why: 'Documents how the product is sold and supported to identify delivery bottlenecks.', options: [{l: 'Direct', v: 1}, {l: 'Channel', v: 1}, {l: 'Hybrid', v: 1}] },
                { id: 'unit_economics', type: 'tiles', question: 'Unit Economics / Lifecycle', required: false, weight: 0.88, doc: 'Rate Card', docId: 'doc_unit_econ', why: 'Ensures pricing reflects long-term maintenance and operating costs.', options: [{l: 'SaaS', v: 1}, {l: 'License', v: 0.8}, {l: 'Utility', v: 0.9}] },
                { id: 'cust_success_lbgups', type: 'checkbox', question: 'Customer Success Process', required: false, weight: 0.88, doc: 'Onboarding Flow', docId: 'doc_cs_flow', why: 'Verification of formal LBGUPS process (Learn, Buy, Get, Use, Pay, Support).' },
                { id: 'gva_contribution', type: 'tiles', question: 'What is your GVA?', required: false, weight: 0.88, doc: 'GVA Report', docId: 'doc_gva_report', why: 'Proof of Gross Value Added (GVA) to justify the mismatch risk for sponsors.', options: [{l: '£25k-£50k', v: 0.5}, {l: '£50k-£100k', v: 0.8}, {l: '>£100k', v: 1}] },
                { id: 'decision_unit_map', type: 'checkbox', question: 'Decision unit mapped?', required: false, weight: 0.88, doc: 'Account Plan', docId: 'doc_dm_map', why: 'Signals sales maturity and understanding of corporate stakeholder mapping.' }
            ]},
            { id: 5, title: 'Operations', icon: ICONS.activity, desc: 'Scalability of support and processes.', rationale: 'Will the founder burn out?', items: [
                // --- REQUIRED SECTION ---
                { id: 'prod_stage', type: 'tiles', question: 'Product stage', required: true, weight: 0.07, doc: 'Product URL', docId: 'doc_stage', why: 'Corporates require MVP or Scaling status; Alpha/Beta stages indicate high stability risk.', options: [{l: 'Pre-Alpha', v: 0}, {l: 'Alpha', v: 0.2}, {l: 'Beta', v: 0.5}, {l: 'Live (MVP)', v: 0.8}, {l: 'Scaling', v: 1}] },
                { id: 'sla_commit', type: 'tiles', question: 'SLA commitment', required: true, weight: 0.06, doc: 'SLA template', docId: 'doc_sla', why: 'Reliability is the primary currency of trust; must align with corporate uptime expectations.', options: [{l: 'Best effort', v: 0.1}, {l: '99.0%', v: 0.6}, {l: '99.9%', v: 0.9}, {l: '99.99%', v: 1}] },
                { id: 'integ_cap', type: 'multi', question: 'Integration Capability', required: true, weight: 0.06, doc: 'API Documentation', docId: 'doc_api_integ', why: 'SSO (SAML) and automated user management (SCIM) are non-negotiable floor requirements.', options: [{l: 'SAML/SSO', v: 1}, {l: 'API', v: 1}, {l: 'SCIM', v: 1}, {l: 'CRM', v: 1}] },
                { id: 'bcp_plan', type: 'checkbox', question: 'Business Continuity Plan (BCP)', required: true, weight: 0.06, doc: 'Tested BCP Document', docId: 'doc_bcp', why: 'Proves the startup can maintain operations during severe but plausible disruptions.' },
                { id: 'dr_backups', type: 'tiles', question: 'Disaster Recovery (DR) Backups', required: true, weight: 0.06, doc: 'DR Testing Log', docId: 'doc_dr_logs', why: 'Ensures data integrity and availability; mandatory for any entity processing corporate data.', options: [{l: 'Manual', v: 0.2}, {l: 'Cloud-native', v: 0.8}, {l: 'Off-site', v: 1}] },
                
                // --- OPTIONAL SECTION ---
                { id: 'supply_social_audit', type: 'text', question: 'Supply Chain Social Audits', required: false, weight: 0.51, doc: 'Audit Summary', docId: 'doc_sc_audit', why: 'Measures the proportion of high-risk suppliers audited for labor violations.' },
                { id: 'safety_incidents', type: 'text', question: 'Workplace Safety Incidents', required: false, weight: 0.51, doc: 'H&S Log', docId: 'doc_safety_log', why: 'Proof of operational safety management, usually required per 200,000 workforce hours.' },
                { id: 'supply_audited', type: 'checkbox', question: 'Supply chain audited?', required: false, weight: 0.51, doc: 'Vendor Audit', docId: 'doc_vendor_audit', why: 'Proactive verification of vendor compliance to mitigate cascading reputational risks.' },
                { id: 'team_size_fte', type: 'tiles', question: 'Team Size (FTEs)', required: false, weight: 0.51, doc: 'Org Chart', docId: 'doc_fte_count', why: '10+ FTEs is the benchmark to ensure back office support for enterprise scale.', options: [{l: '1-5', v: 0.2}, {l: '6-15', v: 0.6}, {l: '16-50', v: 0.9}, {l: '51+', v: 1}] },
                { id: 'back_office_cap', type: 'multi', question: 'Back Office Capability', required: false, weight: 0.51, doc: 'Org Chart', docId: 'doc_back_office', why: 'Verification that internal functions (HR/Legal/Finance) can support complex contracts.', options: [{l: 'HR', v: 1}, {l: 'IT', v: 1}, {l: 'Legal', v: 1}, {l: 'Finance', v: 1}] },
                { id: 'roi_analytics', type: 'tiles', question: 'ROI Tracking & Analytics', required: false, weight: 0.51, doc: 'Sample Dashboard', docId: 'doc_roi_data', why: 'Enables client stakeholders to justify spend with hard data on gains.', options: [{l: 'Dashboards', v: 1}, {l: 'Monthly Reports', v: 0.8}] },
                { id: 'change_mgmt_policy', type: 'checkbox', question: 'Change Management Policy', required: false, weight: 0.51, doc: 'Change/Release Policy', docId: 'doc_change_mgmt', why: 'Prevents "cowboy coding"; ensures updates are versioned and communicated.' },
                { id: 'release_verify', type: 'checkbox', question: 'Release Verification Mechanism', required: false, weight: 0.51, doc: 'QA Workflow', docId: 'doc_qa_verify', why: 'Ensures code changes are approved by someone other than the author.' },
                { id: 'dep_mapping', type: 'checkbox', question: 'Dependency Mapping', required: false, weight: 0.51, doc: 'Architecture Diagram', docId: 'doc_dep_map', why: 'Identifies external services that could cause a "blast radius" failure.' },
                { id: 'sys_throttling', type: 'checkbox', question: 'System Throttling/Limits', required: false, weight: 0.51, doc: 'API Documentation', docId: 'doc_throttle', why: 'Protects workload from customer-driven overload and ensures fair resource allocation.' },
                { id: 'op_res_rto_rpo', type: 'tiles', question: 'Operational resilience (RTO/RPO)', required: false, weight: 0.51, doc: 'BCP / DR Policy', docId: 'doc_res_strategy', why: 'Defines the sustainability risk of vendor failure during critical integration.', options: [{l: 'Next Day +', v: 0.3}, {l: 'Same Day', v: 0.7}, {l: 'Immediate', v: 1}] },
                { id: 'rto_value', type: 'tiles', question: 'Recovery Time Objective (RTO)', required: false, weight: 0.51, doc: 'RTO/RPO Strategy', docId: 'doc_rto_spec', why: 'Maximum allowable downtime before unacceptable impact occurs to the client.', options: [{l: '<1h', v: 1}, {l: '1-4h', v: 0.7}, {l: '4-24h', v: 0.4}, {l: '24h+', v: 0.1}] },
                { id: 'rpo_value', type: 'text', question: 'Recovery Point Objective (RPO)', required: false, weight: 0.51, doc: 'RTO/RPO Strategy', docId: 'doc_rpo_spec', why: 'Defines the maximum allowable data loss (time since last backup) during an outage.' },
                { id: 'named_account_mgmt', type: 'checkbox', question: 'Named Account Management', required: false, weight: 0.51, doc: 'Support Policy', docId: 'doc_acc_mgmt', why: 'Corporates expect a dedicated human point of contact for escalations and strategy.' },
                { id: 'dedicated_support', type: 'checkbox', question: 'Dedicated support system?', required: false, weight: 0.51, doc: 'System screenshot', docId: 'doc_support_sys', why: 'Verification that issues are tracked via professional ticketing instead of ad-hoc emails.' },
                { id: 'key_person_risk', type: 'checkbox', question: 'Key-Person Risk Mitigation', required: false, weight: 0.51, doc: 'Succession Plan', docId: 'doc_key_risk', why: 'Ensures service continuity is not dependent on a single founder.' },
                { id: 'corp_event_cal', type: 'checkbox', question: 'Calendar of Corporate Events', required: false, weight: 0.51, doc: 'Board Calendar', docId: 'doc_event_cal', why: 'Proof of regular board meetings to discuss risks and strategic alignment.' },
                { id: 'local_multiplier', type: 'text', question: 'Local multiplier effect', required: false, weight: 0.51, doc: 'Economic statement', docId: 'doc_local_impact', why: 'Demonstrates economic benefit of spending with local SMEs for social value targets.' }
            ]}
        ];

        const SECTOR_MODULES = {
            fin: { id: 'fin', title: 'Financial services', badgeName: 'FinTech verified', icon: '💰', items: [
                // --- REQUIRED SECTION ---
                { id: 'fca_authorised', type: 'multi', question: 'Is the entity FCA authorised?', required: true, weight: 0.1, doc: 'FCA Registration', docId: 'doc_fca', why: 'Absolute legal requirement to provide regulated financial services in the UK market.' },
                { id: 'aml_kyc_framework', type: 'checkbox', question: 'AML / KYC Control Framework?', required: true, weight: 0.1, doc: 'AML Policy', docId: 'doc_aml', why: 'Mandatory for de-risking financial crime; proves robust customer monitoring.' },
                { id: 'dora_compliance', type: 'checkbox', question: 'DORA ICT Risk Framework?', required: true, weight: 0.1, doc: 'ICT Risk Manual', docId: 'doc_dora', why: 'Mandatory baseline for ICT providers to meet 2026 digital resilience standards.' },
                { id: 'ibs_mapping', type: 'multi', question: 'Important Business Services (IBS)?', required: true, weight: 0.1, doc: 'IBS Map', docId: 'doc_ibs', why: 'Identification of services whose failure would cause intolerable harm to markets.' },
                
                // --- OPTIONAL SECTION ---
                { id: 'impact_tolerances', type: 'checkbox', question: 'Tested Impact Tolerances?', required: false, weight: 1.6, doc: 'Testing Summary', docId: 'doc_tolerances', why: 'Proves firm has tested ability to remain within defined limits during disruption.' },
                { id: 'consumer_duty', type: 'checkbox', question: 'Consumer Duty Evidence?', required: false, weight: 1.6, doc: 'Outcome Report', docId: 'doc_cons_duty', why: 'Proves the solution delivers "good outcomes" for retail customers per Principle 12.' },
                { id: 'tlpt_testing', type: 'tiles', question: 'Threat-Led Pen Testing (TLPT)?', required: false, weight: 1.6, doc: 'TLPT Report', docId: 'doc_tlpt', why: 'Advanced real-world simulation of cyber threats (TIBER-EU/DORA).', options: [{l: '< 12 mo', v: 1}, {l: '> 12 mo', v: 0.4}] },
                { id: 'dora_roi', type: 'checkbox', question: 'Register of Information (RoI)?', required: false, weight: 1.6, doc: 'RoI Export', docId: 'doc_roi', why: 'Specific DORA requirement: a map of all ICT third-party dependencies.' },
                { id: 'op_res_self_asmnt', type: 'checkbox', question: 'Op Resilience Self-Assessment?', required: false, weight: 1.6, doc: 'Self-Assessment', docId: 'doc_op_res', why: 'The Regulatory Gold Standard; justifies the firm’s resilience strategy.' },
                { id: 'pci_psd_compliance', type: 'tiles', question: 'PCI-DSS / PSD3 Compliance?', required: false, weight: 1.6, doc: 'AOC Document', docId: 'doc_pci', why: 'Industry standard for payment processing security across the EEA and UK.', options: [{l: 'Level 1', v: 1}, {l: 'Level 2', v: 0.8}, {l: 'Level 3', v: 0.6}, {l: 'Level 4', v: 0.4}] }
            ]},
            health: { id: 'health', title: 'Healthcare', badgeName: 'HealthTech verified', icon: '🏥', items: [
                // --- REQUIRED SECTION ---
                { id: 'dpia_status', type: 'tiles', question: 'DPIA for this solution?', required: true, weight: 0.3, doc: 'DPIA Document', docId: 'doc_dpia', why: 'Mandatory under UK GDPR for systems processing sensitive health or biometric data.', options: [{l: 'Yes', v: 1}, {l: 'No', v: 0}] },
                { id: 'caldicott_guardian', type: 'checkbox', question: 'Caldicott Guardian named?', required: true, weight: 0.3, doc: 'Appointment Letter', docId: 'doc_caldicott', why: 'NHS requirement: a senior person responsible for protecting patient confidentiality.' },
                { id: 'cyber_essentials_basic', type: 'checkbox', question: 'Cyber Essentials (Basic)?', required: true, weight: 0.3, doc: 'CE Certificate', docId: 'doc_ce_hea', why: 'Baseline technical requirement; proof of protection against common threats.' },
                { id: 'nhs_ig_training', type: 'text', question: 'NHS IG Training Log?', required: true, weight: 0.3, doc: 'Training Report', docId: 'doc_ig_train', why: 'Non-negotiable floor: 95% of staff must complete annual Data Security Awareness training.' },
                
                // --- OPTIONAL SECTION ---
                { id: 'nhs_carbon_plan', type: 'checkbox', question: 'NHS Carbon Reduction Plan?', required: false, weight: 0.88, doc: 'Carbon Plan', docId: 'doc_nhs_carbon', why: '2026 mandate: firms must provide a Net Zero commitment for major NHS frameworks.' },
                { id: 'fhir_hl7_support', type: 'tiles', question: 'FHIR / HL7 API Support?', required: false, weight: 0.88, doc: 'API Spec', docId: 'doc_health_api', why: 'Strategic differentiator; ensures interoperability with central clinical records.', options: [{l: 'FHIR v4', v: 1}, {l: 'HL7 v2', v: 0.7}, {l: 'None', v: 0}] },
                { id: 'cyber_essentials_plus', type: 'checkbox', question: 'Cyber Essentials Plus?', required: false, weight: 0.88, doc: 'CE+ Certificate', docId: 'doc_ce_plus_hea', why: 'High-trust tier; independent technical verification bypassing manual IT audits.' },
                { id: 'ai_clinical_bias', type: 'checkbox', question: 'AI Clinical Bias Evidence?', required: false, weight: 0.88, doc: 'Bias Audit Log', docId: 'doc_ai_bias', why: '2026 benchmark: proof that diagnostic algorithms do not exhibit racial or gender bias.' },
                { id: 'csms_policy', type: 'checkbox', question: 'Safety Mgmt System (CSMS)?', required: false, weight: 0.88, doc: 'CSMS Policy', docId: 'doc_csms', why: 'Proves a formal Clinical Safety Management System is in place to monitor risks.' },
                { id: 'clinical_hazard_log', type: 'checkbox', question: 'Live Clinical Hazard Log?', required: false, weight: 0.88, doc: 'Hazard Log', docId: 'doc_hazard_log', why: 'Documentation of all known risks and mitigations, essential for clinical governance.' },
                { id: 'clinical_neg_pi', type: 'tiles', question: 'Clinical Negligence PI?', required: false, weight: 0.88, doc: 'Insurance Sch.', docId: 'doc_clinical_ins', why: 'Covers liabilities arising from algorithmic errors or clinical advice.', options: [{l: 'Standard', v: 0.5}, {l: 'Clinical Specific', v: 1}] },
                { id: 'wcag_accessibility', type: 'checkbox', question: 'WCAG 2.1 AA Accessibility?', required: false, weight: 0.88, doc: 'Access Audit', docId: 'doc_wcag_hea', why: 'Legal duty for patient-facing tech to be usable by those with diverse needs.' },
                { id: 'cqc_status', type: 'checkbox', question: 'CQC Registered Status?', required: false, weight: 0.88, doc: 'CQC Cert', docId: 'doc_cqc', why: 'Required if providing Regulated Activities like remote diagnosis or triage.' },
                { id: 'dspt_standards', type: 'checkbox', question: 'DSPT Standards Exceeded?', required: false, weight: 0.88, doc: 'DSPT Publication', docId: 'doc_dspt_high', why: 'Highest data trust tier; signals SME operation at a Prime Contractor level.' }
            ]},
            gov: { id: 'gov', title: 'Public sector', badgeName: 'GovFramework verified', icon: '🏛️', items: [
                // --- REQUIRED SECTION ---
                { id: 'gov_ce_basic', type: 'checkbox', question: 'Cyber Essentials (Basic)', required: true, weight: 0.1, doc: 'CE Certificate', docId: 'doc_ce_pub', why: 'Entry-level security floor for contracts handling non-sensitive government data.' },
                { id: 'gov_wcag_aa', type: 'checkbox', question: 'WCAG 2.1 AA Compliance', required: true, weight: 0.1, doc: 'Accessibility Audit', docId: 'doc_wcag_pub', why: 'Statutory legal duty to ensure digital services are accessible to all citizens.' },
                { id: 'gov_social_val_pol', type: 'checkbox', question: 'Social Value Policy Defined', required: true, weight: 0.1, doc: 'Social Value Policy', docId: 'doc_sv_pol', why: 'Mandatory requirement to prove strategy for social, economic, or environmental benefits.' },
                { id: 'gov_modern_slavery', type: 'checkbox', question: 'Modern Slavery Compliance', required: true, weight: 0.1, doc: 'Written Statement', docId: 'doc_ms_pub', why: 'Verification of risk mitigation for slavery in teams and supply chains.' },
                { id: 'gov_ins_limit', type: 'checkbox', question: 'Ins. (PI/PL £5m+ Min)', required: true, weight: 0.1, doc: 'Insurance Schedule', docId: 'doc_pub_ins', why: 'Standard contractual floor required by the Crown Commercial Service (CCS).' },
                
                // --- OPTIONAL SECTION ---
                { id: 'gov_ce_plus', type: 'checkbox', question: 'Cyber Essentials Plus', required: false, weight: 0.95, doc: 'CE+ Certificate', docId: 'doc_ce_plus_pub', why: 'Government High-Trust tier; independent verification bypassing long security reviews.' },
                { id: 'gov_carbon_plan', type: 'checkbox', question: 'PPN 06/21 Carbon Plan', required: false, weight: 0.95, doc: 'CRP Document', docId: 'doc_pub_carbon', why: 'Required for contracts over £5m; proves commitment to Net Zero by 2050.' },
                { id: 'gov_frameworks', type: 'multi', question: 'Framework Presence', required: false, weight: 0.95, doc: 'Framework ID', docId: 'doc_pub_fw', why: 'Pre-vetted status on CCS portals significantly reduces sales cycles.', options: [{l: 'G-Cloud', v: 1}, {l: 'DOS', v: 1}, {l: 'DPS', v: 1}] },
                { id: 'gov_gov_platform_id', type: 'text', question: 'Central Digital Platform ID', required: false, weight: 0.95, doc: 'Platform Profile', docId: 'doc_gov_id', why: 'Readiness for 2026 "Tell Us Once" mandate; ensures data is pre-verified.' },
                { id: 'gov_security_clearance', type: 'text', question: 'Security Clearance (SC)', required: false, weight: 0.95, doc: 'BPSS/SC Log', docId: 'doc_sc_staff', why: 'Identifies capacity to handle "Secret" or "Official-Sensitive" data.' },
                { id: 'gov_impact_data', type: 'checkbox', question: 'Quantitative Impact Data', required: false, weight: 0.95, doc: 'Last Impact Report', docId: 'doc_impact_rpt', why: 'Proves capability to report hard metrics like local apprenticeship creation.' },
                { id: 'gov_sroi_ratio', type: 'text', question:'Social ROI (SROI) Data' , required:false, weight : 0.95 , doc : "SROI Methodology", docId : "doc_sroi", why : "Quantifies the financial value of social impact generated for every £1 spent." },
                { id: 'gov_iso_9001' , type:'checkbox' , question:'ISO 9001 Quality Mgmt' , required:false , weight : 0.95 , doc : "Quality Certificate", docId : "doc_pub_iso", why:"Signals standardized processes for delivery, feedback, and improvement." },
                { id: 'gov_prompt_payment' , type:'text' , question:'Prompt Payment (>95%)' , required:false , weight : 0.95 , doc : "Payment Records", docId : "doc_prompt_pay", why:"Aligns with PPN 10/23; protects SME supply chain health." },
                { id: 'gov_sme_spend' , type:'text' , question:'SME Supply Chain Spend %' , required:false , weight : 0.95 , doc : "Tier 2 Spend Log", docId : "doc_sme_spend", why:"Supports the Government 33% target for spend reaching SMEs." }
            ]},
            retail: { id: 'retail', title: 'Retail', badgeName: 'Retail verified', icon: '🛍️', items: [
                // --- REQUIRED SECTION ---
                { id: 'sedex_smeta_audit', type: 'checkbox', question: 'Sedex / SMETA Audit?', required: true, weight: 0.1, doc: 'Audit Report', docId: 'doc_sedex', why: 'Mandatory ethical sourcing verification; required to mitigate labor risks in the brand.' },
                { id: 'gs1_gtin_align', type: 'checkbox', question: 'GS1 GTIN Alignment?', required: true, weight: 0.11, doc: 'GS1 Cert', docId: 'doc_gs1', why: 'Universal product identifier; essential for listing items in global inventory and POS systems.' },
                { id: 'product_safety_cert', type: 'checkbox', question: 'Product Safety Certs?', required: true, weight: 0.11, doc: 'Safety Docs', docId: 'doc_safety_cert', why: 'Verification of compliance with UKCA/CE and REACH for physical or IoT goods.' },
                { id: 'consumer_data_sec', type: 'checkbox', question: 'Consumer Data Security', required: true, weight: 0.11, doc: 'Security Policy', docId: 'doc_retail_sec', why: 'Mandatory floor for startups handling customer PII, loyalty, or transaction records.' },
                
                // --- OPTIONAL SECTION ---
                { id: 'edi_support', type: 'checkbox', question: 'EDI Support (AS2/SFTP)', required: false, weight: 0.87, doc: 'Tech Spec', docId: 'doc_edi', why: 'Allows automated flow of orders and invoices through the retailer’s ERP.' },
                { id: 'unit_traceability', type: 'checkbox', question: 'Item-Level Traceability', required: false, weight: 0.87, doc: 'Traceability Map', docId: 'doc_trace', why: 'The 2026 transparency benchmark: tracking unit journey from source to shelf.' },
                { id: 'inventory_api', type: 'checkbox', question: 'Real-time Inventory API', required: false, weight: 0.87, doc: 'API Doc', docId: 'doc_inv_api', why: 'Critical for Omnichannel; prevents "Out of Stock" events via live visibility.' },
                { id: 'circular_econ_plan', type: 'checkbox', question: 'Circular Economy Plan', required: false, weight: 0.87, doc: 'Circularity Policy', docId: 'doc_circularity', why: 'Aligns with 2026 shift toward repairability and sustainable end-of-life recycling.' },
                { id: 'logistics_otif', type: 'text', question: 'Logistics (OTIF) %', required: false, weight: 0.87, doc: 'Performance Log', docId: 'doc_otif', why: 'Measures "On-Time In-Full" performance; Tier-1s typically require >98% reliability.' },
                { id: 'rfid_ready', type: 'checkbox', question: 'RFID Tagging Ready?', required: false, weight: 0.87, doc: 'RFID Workflow', docId: 'doc_rfid', why: 'Enables automated stock-takes and reduces shrinkage in high-volume environments.' },
                { id: 'supplier_map_deep', type: 'checkbox', question: 'Tier 2/3 Supplier Map', required: false, weight: 0.87, doc: 'Value Chain Map', docId: 'doc_vchain_map', why: 'Identifies "supplier\'s suppliers" to prevent cascading risks in the global value chain.' },
                { id: 'returns_automation', type: 'checkbox', question: 'Returns Automation?', required: false, weight: 0.87, doc: 'Returns Policy', docId: 'doc_returns', why: 'Formal process for re-integrating returns to minimize waste and cost.' },
                { id: 'supplier_diversity_pct', type: 'text', question: 'Supplier Diversity %', required: false, weight: 0.87, doc: 'Diversity Report', docId: 'doc_diversity', why: 'Tracks how much spend reaches diverse-led businesses for social value targets.' },
                { id: 'reach_rohs_compliant', type: 'checkbox', question: 'REACH / RoHS Compliant', required: false, weight: 0.87, doc: 'Declaration', docId: 'doc_reach', why: 'Ensures no restricted hazardous substances are present in hardware/electronics.' },
                { id: 'last_mile_integ', type: 'checkbox', question: 'Last-Mile Integration', required: false, weight: 0.87, doc: 'Integration Guide', docId: 'doc_last_mile', why: 'Ability to plug into 3rd-party logistics (3PL) or direct-to-consumer networks.' }
            ]},
            aero: { id: 'aero', title: 'Aerospace & defence', badgeName: 'Aero/Def verified', icon: '⚙️', items: [
                // --- REQUIRED SECTION ---
                { id: 'as9100_cert', type: 'checkbox', question: 'Is AS9100 / Def Stan certified?', required: true, weight: 0.1, doc: 'Quality Certificate', docId: 'doc_as9100', why: 'The Gold Standard for quality; incorporates ISO 9001 with specific safety requirements for ASD.' },
                { id: 'export_compliant', type: 'checkbox', question: 'Is ITAR / EAR / Export compliant?', required: true, weight: 0.1, doc: 'Export Policy', docId: 'doc_export_ctrl', why: 'Mandatory for dual-use tech; ensures compliance with US and UK Strategic Export Control lists.' },
                { id: 'cyber_essentials_plus', type: 'checkbox', question: 'Is Cyber Essentials Plus held?', required: true, weight: 0.1, doc: 'CE+ Certificate', docId: 'doc_ce_plus', why: 'Absolute technical floor for MOD suppliers handling "Official" or higher data.' },
                { id: 'ncage_code', type: 'text', question: 'Is NCAGE / CAGE Code held?', required: true, weight: 0.1, doc: 'Registration Proof', docId: 'doc_ncage', why: 'NATO Commercial and Government Entity code; essential for inclusion in NATO supply systems.' },
                
                // --- OPTIONAL SECTION ---
                { id: 'joscar_status', type: 'tiles', question: 'Is JOSCAR registered?', required: false, weight: 1.6, doc: 'JOSCAR Profile', docId: 'doc_joscar', why: 'A cross-Prime register that removes the need for duplicate pre-qualification audits.', options: [{l: 'Stage 1', v: 0.5}, {l: 'Stage 2', v: 1}] },
                { id: 'nadcap_accred', type: 'checkbox', question: 'Is Nadcap accredited?', required: false, weight: 1.6, doc: 'Nadcap Cert', docId: 'doc_nadcap', why: 'Required for "Special Processes" like heat treating and non-destructive testing.' },
                { id: 'as9102_fair', type: 'checkbox', question: 'AS9102 FAIR process in place?', required: false, weight: 1.6, doc: 'Sample FAIR', docId: 'doc_fair', why: 'Verifies production processes can consistently produce parts to spec (First Article Inspection).' },
                { id: 'safety_mgmt_sys', type: 'checkbox', question: 'Safety Management System (SMS)?', required: false, weight: 1.6, doc: 'SMS Manual', docId: 'doc_sms', why: 'Advanced governance proving a proactive approach to hazard identification (EASA/FAA standard).' },
                { id: 'part_21_approval', type: 'checkbox', question: 'EASA / FAA Part 21 Approvals?', required: false, weight: 1.6, doc: 'Approval Cert', docId: 'doc_part21', why: 'Critical for hardware; proves authority to design (DOA) or manufacture (POA) airworthy components.' },
                { id: 'social_value_align', type: 'multi', question: 'Social Value Model Alignment?', required: false, weight: 1.6, doc: 'Social Value Pol.', docId: 'doc_soc_val', why: 'UK MOD tenders mandate a minimum 10% weighting for social value themes.', options: [{l: 'Theme 1', v: 1}, {l: 'Theme 2', v: 1}, {l: 'Theme 3', v: 1}, {l: 'Theme 4', v: 1}, {l: 'Theme 5', v: 1}] }    
            ]},
            sustainability: { id: 'sustainability', title: 'Sustainability', badgeName: 'Eco verified', icon: '🌱', items: [
                // --- REQUIRED SECTION ---
                { id: 'scope_1_2', type: 'multi', question: 'Scope 1 & 2 Emissions', required: true, weight: 0.15, doc: 'Emissions Report', docId: 'doc_s12', why: 'Basic carbon disclosure required for corporate CSRD reporting.' },
                { id: 'climate_trans_plan', type: 'checkbox', question: 'Climate Transition Plan', required: true, weight: 0.15, doc: 'Transition Plan', docId: 'doc_trans_plan', why: 'Time-bound, science-based pathway to reaching Net Zero.' },
                { id: 'emissions_rpt_lvl', type: 'tiles', question: 'Emissions Reporting Level', required: true, weight: 0.16, doc: 'Carbon Report', docId: 'doc_carbon_rpt', why: 'Boundary check for which emissions the startup is tracking.', options: [{l: 'Scope 1-2', v: 0.6}, {l: 'Scope 1-3', v: 1}] },
                
                // --- REQUIRED SECTION ---
                { id: 'scope_3_data', type: 'multi', question: 'Scope 3 Value Chain Data', required: false, weight: 1.06, doc: 'Scope 3 Data Set', docId: 'doc_s3_data', why: 'Advanced disclosure of indirect value-chain emissions.' },
                { id: 'double_materiality', type: 'checkbox', question: 'Double Materiality (DMA)', required: false, weight: 1.06, doc: 'DMA Report', docId: 'doc_dma', why: '2026 strategic benchmark: understanding both impact and financial risk.' },
                { id: 'hotspot_breakdown', type: 'multi', question: 'Hotspot Breakdown', required: false, weight: 1.06, doc: 'Hotspot Map', docId: 'doc_hotspots', why: 'Detailed transparency on where 80%+ of indirect emissions reside.' },
                { id: 'product_carbon_unit', type: 'text', question: 'Product Carbon Footprint', required: false, weight: 1.06, doc: 'LCA Report', docId: 'doc_lca', why: 'Critical for manufacturing; provides kg CO2e per unit for client data.' },
                { id: 'cloud_embodied_carbon', type: 'checkbox', question: 'Embodied Carbon (Cloud)', required: false, weight: 1.06, doc: 'Cloud ESG Report', docId: 'doc_cloud_esg', why: 'Mandatory for AI/Software; provides carbon data for infrastructure.' },
                { id: 'auto_esg_reporting', type: 'checkbox', question: 'Automated Reporting', required: false, weight: 1.06, doc: 'Tech Spec', docId: 'doc_auto_esg', why: 'Allows "pushing" data directly to client procurement systems.' },
                { id: 'recycling_plan', type: 'multi', question: 'Recyclability Plan', required: false, weight: 1.06, doc: 'Circularity Policy', docId: 'doc_recycle', why: 'Aligns with 2026 Circular Economy rules for hardware and tech.' },
                { id: 'energy_source_breakdown', type: 'multi', question: 'Energy by Source', required: false, weight: 1.06, doc: 'Utility Summary', docId: 'doc_energy_src', why: 'Breakdown of renewable use to validate green claims.' },
                { id: 'nature_risk_screen', type: 'checkbox', question: 'Nature Risk Screening', required: false, weight: 1.06, doc: 'Nature Policy', docId: 'doc_nature_risk', why: 'Emerging requirement for impact on sensitive biodiversity areas.' }
            ]}
        };

        class App {
            constructor() {
                this.state = {
                    answers: {}, selections: {}, sectorAnswers: {}, uploads: new Set(),
                    currentSlide: 0, currentSector: 'fin',
                    formData: { country: 'uk' }, currency: '£',
                    chartValues: {1:1,2:1,3:1,4:1,5:1}, targetValues: {1:1,2:1,3:1,4:1,5:1}
                };
                this.init();
            }

            init() {
                this.renderCountryOptions();
                this.updateRegistryHint();
                this.renderChart(this.state.chartValues);
                this.animateChart();
                this.updateAll();
            }

            async submitAssessment() {
                const scores = this.calculateScores();
                const companyName = document.getElementById('regName').value || 'Untitled Company';
                const submission = {
                    id: 'submission-' + Date.now(),
                    timestamp: new Date().toISOString(),
                    company_info: {
                        name: companyName,
                        reg_no: document.getElementById('regNo').value,
                        website: document.getElementById('website').value,
                        address: { line1: document.getElementById('addr1').value, line2: document.getElementById('addr2').value, city: document.getElementById('city').value, state: document.getElementById('state').value, zip: document.getElementById('zip').value },
                        country: this.state.formData.country, currency: this.state.currency
                    },
                    selected_sector: this.state.currentSector,
                    core_answers: this.state.answers,
                    sector_answers: this.state.sectorAnswers,
                    uploaded_documents: Array.from(this.state.uploads),
                    scores: scores
                };
                await window.saveSubmission(submission);
                const toast = document.createElement('div');
                toast.className = 'fixed top-6 right-6 z-[9999] bg-fm-charcoal text-white text-sm font-bold px-6 py-3 rounded-xl shadow-xl flex items-center gap-3 transition-all';
                toast.innerHTML = '<span style="color:#D9EB31">✓</span> Assessment submitted for <strong>' + companyName + '</strong>';
                document.body.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-8px)'; setTimeout(() => toast.remove(), 400); }, 3000);
                setTimeout(() => switchView('Assessment-Admin'), 800);
            }

            downloadAssessment() {
                const scores = this.calculateScores();
                const exportData = { id: 'submission-' + Date.now(), timestamp: new Date().toISOString(), company_info: { name: document.getElementById('regName').value || 'Untitled Company', reg_no: document.getElementById('regNo').value, website: document.getElementById('website').value, country: this.state.formData.country, currency: this.state.currency }, selected_sector: this.state.currentSector, core_answers: this.state.answers, sector_answers: this.state.sectorAnswers, uploaded_documents: Array.from(this.state.uploads), scores: scores };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
                const a = document.createElement('a');
                a.setAttribute("href", dataStr);
                a.setAttribute("download", "founders_match_assessment.json");
                document.body.appendChild(a);
                a.click();
                a.remove();
            }

            animateChart() {
                let changed = false;
                for (let i = 1; i <= 5; i++) {
                    const diff = this.state.targetValues[i] - this.state.chartValues[i];
                    if (Math.abs(diff) > 0.005) { this.state.chartValues[i] += diff * 0.1; changed = true; }
                    else { this.state.chartValues[i] = this.state.targetValues[i]; }
                }
                if (changed) this.updateChartVisuals(this.state.chartValues);
                requestAnimationFrame(() => this.animateChart());
            }

            toggleCheck(dimId, itemIdx) {
                const currentVal = this.state.answers[dimId]?.[itemIdx] || 0;
                this.handleAnswer(dimId, itemIdx, currentVal ? 0 : 1);
            }

            toggleSectorCheck(sectorId, itemId) {
                const currentVal = this.state.sectorAnswers[sectorId]?.[itemId];
                this.handleSectorAnswer(sectorId, itemId, !currentVal);
            }

            handleSectorTile(sectorId, itemId, value, optIndex) {
                if (!this.state.sectorAnswers[sectorId]) this.state.sectorAnswers[sectorId] = {};
                this.state.sectorAnswers[sectorId][itemId] = value === 0 ? 0.001 : value;
                this.state.sectorAnswers[sectorId][itemId + '_opt'] = optIndex;
                this.updateSectorView();
                this.renderBadges(this.calculateScores());
            }

            handleSectorText(sectorId, itemId, value) {
                if (!this.state.sectorAnswers[sectorId]) this.state.sectorAnswers[sectorId] = {};
                this.state.sectorAnswers[sectorId][itemId] = value;
                this.updateSectorView();
                this.renderBadges(this.calculateScores());
            }

            handleAnswer(dimId, itemIdx, value, optIndex = null) {
                if (!this.state.answers[dimId]) this.state.answers[dimId] = {};
                this.state.answers[dimId][itemIdx] = value;
                if (optIndex !== null) {
                    if (!this.state.selections[dimId]) this.state.selections[dimId] = {};
                    this.state.selections[dimId][itemIdx] = optIndex;
                }
                this.updateUIForAnswer(dimId, itemIdx, value, optIndex);
                this.recalculateTargets();
            }

            updateUIForAnswer(dimId, itemIdx, value, optIndex) {
                const item = CORE_DIMENSIONS.find(d => d.id === dimId).items[itemIdx];
                const isUploaded = this.state.uploads.has(item.docId);
                if (item.type === 'tiles') {
                    const group = document.getElementById(`tiles-${dimId}-${itemIdx}`);
                    if (group) Array.from(group.children).forEach((btn, idx) => {
                        btn.className = idx === optIndex
                            ? 'flex-1 py-2 px-3 rounded border text-xs font-bold transition-all bg-[#ECF598] border-[#475609] text-[#2B2A2A]'
                            : 'flex-1 py-2 px-3 rounded border text-xs font-medium transition-all border-slate-200 text-slate-500 hover:border-slate-400 hover:bg-[#F8F8F8]';
                    });
                } else {
                    const checkContainer = document.getElementById(`check-${dimId}-${itemIdx}`);
                    if (checkContainer) {
                        const box = checkContainer.querySelector('div');
                        if (value) { box.className = 'w-5 h-5 flex-shrink-0 rounded border-2 flex items-center justify-center transition-all bg-[#D9EB31] border-[#475609]'; box.innerHTML = `<span class="text-[#475609]">${ICONS.check}</span>`; }
                        else { box.className = 'w-5 h-5 flex-shrink-0 rounded border-2 flex items-center justify-center transition-all border-slate-300 bg-white'; box.style.border = '2px solid #cbd5e1'; box.innerHTML = ''; }
                    }
                }
                const reveal = document.getElementById(`reveal-${dimId}-${itemIdx}`);
                const isAnswered = (item.type === 'tiles' && optIndex !== null && optIndex !== -1) || (item.type !== 'tiles' && value > 0);
                if (reveal) {
                    if (isAnswered) { reveal.classList.remove('max-h-0', 'opacity-0', 'pointer-events-none'); reveal.classList.add('max-h-[300px]', 'opacity-100', 'mt-3', 'pt-3', 'border-t', 'border-dashed', 'border-slate-100'); }
                    else { reveal.classList.add('max-h-0', 'opacity-0', 'pointer-events-none'); reveal.classList.remove('max-h-[300px]', 'opacity-100', 'mt-3', 'pt-3', 'border-t', 'border-dashed', 'border-slate-100'); }
                }
                const warningDiv = document.getElementById(`doc-warning-${dimId}-${itemIdx}`);
                if (warningDiv) { if (value > 0 && !isUploaded) warningDiv.classList.remove('hidden'); else warningDiv.classList.add('hidden'); }
                this.checkRequirements(dimId);
            }

            recalculateTargets() {
                const scores = this.calculateScores();
                this.state.targetValues = scores;
                this.renderStats(scores);
                this.renderBadges(scores);
            }

            checkRequirements(dimId) {
                const dim = CORE_DIMENSIONS.find(d => d.id === dimId);
                const answers = this.state.answers[dimId] || {};
                const selections = this.state.selections[dimId] || {};
                let missing = false;
                dim.items.forEach((item, idx) => {
                    if (item.required) {
                        const val = answers[idx] || 0;
                        const optIdx = selections[idx];
                        const isAnswered = (item.type === 'tiles' && optIdx !== undefined) || (item.type !== 'tiles' && val > 0);
                        if (!isAnswered || (val > 0 && !this.state.uploads.has(item.docId))) missing = true;
                    }
                });
                const warningEl = document.getElementById(`warning-${dimId}`);
                const scoreEl = document.getElementById(`score-display-${dimId}`);
                if (warningEl) { if (missing) { warningEl.classList.remove('hidden'); if (scoreEl) scoreEl.classList.add('text-amber-600'); } else { warningEl.classList.add('hidden'); if (scoreEl) scoreEl.classList.remove('text-amber-600'); } }
            }

            handleSectorAnswer(sectorId, itemId, checked) {
                if (!this.state.sectorAnswers[sectorId]) this.state.sectorAnswers[sectorId] = {};
                this.state.sectorAnswers[sectorId][itemId] = checked;
                const el = document.getElementById(`sec-check-${sectorId}-${itemId}`);
                if (el) {
                    const box = el.querySelector('div');
                    if (checked) { box.className = 'w-4 h-4 flex-shrink-0 rounded border flex items-center justify-center transition-all bg-[#D9EB31] border-[#D9EB31]'; box.innerHTML = `<span class="text-[#2B2A2A]">${ICONS.check}</span>`; }
                    else { box.className = 'w-4 h-4 flex-shrink-0 rounded border flex items-center justify-center transition-all border-slate-500 bg-transparent'; box.style.border = '1px solid #64748b'; box.innerHTML = ''; }
                }
                this.renderBadges(this.calculateScores());
            }

            handleUpload(docId) {
                if (this.state.uploads.has(docId)) this.state.uploads.delete(docId);
                else {
                    this.state.uploads.add(docId);
                    CORE_DIMENSIONS.forEach(dim => dim.items.forEach((item, idx) => { if (item.docId === docId && item.type === 'checkbox') this.handleAnswer(dim.id, idx, 1); }));
                    Object.keys(SECTOR_MODULES).forEach(key => SECTOR_MODULES[key].items.forEach(item => { if (item.docId === docId) this.handleSectorAnswer(key, item.id, true); }));
                }
                this.updateDocButtons();
                this.updateSectorView();
                this.recalculateTargets();
                this.updateCoreProtocol();
            }

            toggleCountryDropdown(e) {
                if (e) e.stopPropagation();
                document.getElementById('country-menu').classList.toggle('hidden');
            }

            selectCountry(code, label) {
                this.state.formData.country = code;
                let currency = '€';
                if (code === 'uk') currency = '£';
                else if (code === 'us') currency = '$';
                const currSelect = document.getElementById('currency-selector');
                if (currSelect) currSelect.value = currency;
                this.setCurrency(currency);
                document.getElementById('country-selected-text').innerText = label;
                document.getElementById('country-menu').classList.add('hidden');
                this.updateRegistryHint();
            }

            setCurrency(c) {
                this.state.currency = c;
                const sel = document.getElementById('currency-selector');
                if (sel) sel.value = c;
                this.updateCoreProtocol();
                this.updateSectorView();
            }

            changeSlide(dir) {
                this.state.currentSlide = (this.state.currentSlide + dir + CORE_DIMENSIONS.length) % CORE_DIMENSIONS.length;
                this.updateCoreProtocol();
            }

            setSector(secId) { this.state.currentSector = secId; this.updateSectorView(); }

            resetAll() {
                this.state.answers = {}; this.state.selections = {}; this.state.sectorAnswers = {}; this.state.uploads = new Set(); this.state.currentSlide = 0; this.state.targetValues = {1:1,2:1,3:1,4:1,5:1};
                ['regName','regNo','website','addr1','addr2','city','state','zip'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                this.updateRegistryHint();
                this.updateAll();
            }

            calculateScores() {
                const scores = {};
                CORE_DIMENSIONS.forEach(dim => {
                    const dimAns = this.state.answers[dim.id] || {};
                    let totalWeightedScore = 0, totalPossibleWeight = 0;
                    dim.items.forEach((item, idx) => {
                        totalPossibleWeight += item.weight;
                        let val = dimAns[idx] || 0;
                        if (val > 0) {
                            const isUploaded = this.state.uploads.has(item.docId);
                            if (!isUploaded) val = item.required ? 0 : val * 0.5;
                        }
                        totalWeightedScore += val * item.weight;
                    });
                    const pct = totalPossibleWeight === 0 ? 0 : totalWeightedScore / totalPossibleWeight;
                    scores[dim.id] = Math.max(1, Math.min(5, 1 + pct * 4));
                });
                return scores;
            }

            updateAll() { this.recalculateTargets(); this.updateDocButtons(); this.updateCoreProtocol(); this.updateSectorView(); }
            formatText(text) { return text.replace(/£/g, this.state.currency); }

            renderCountryOptions() {
                const countries = [{code:'fr',label:'France'},{code:'de',label:'Germany'},{code:'gr',label:'Greece'},{code:'is',label:'Iceland'},{code:'ie',label:'Ireland'},{code:'it',label:'Italy'},{code:'lv',label:'Latvia'},{code:'lu',label:'Luxembourg'},{code:'nl',label:'Netherlands'},{code:'se',label:'Nordics (SE/DK/NO/FI)'},{code:'es',label:'Spain'},{code:'uk',label:'United Kingdom'},{code:'eu_other',label:'Rest of Europe'}];
                const menu = document.getElementById('country-menu');
                menu.innerHTML = countries.map(c => `<button type="button" onclick="app.selectCountry('${c.code}','${c.label}')" class="w-full text-left px-4 py-2 text-sm text-fm-charcoal hover:bg-slate-50 transition-colors">${c.label}</button>`).join('');
            }

            updateRegistryHint() {
                const info = REGISTRY_INFO[this.state.formData.country] || REGISTRY_INFO['uk'];
                document.getElementById('regNo').placeholder = info.label;
                const btn = document.getElementById('btn-doc_incorp');
                if (btn) this.renderDocButton(btn, 'doc_incorp', info.doc, this.state.uploads.has('doc_incorp'));
            }

            renderChart(scores) {
                const labels = ['Structure','Security','AI Gov','Commercial','Operations'];
                const size = 300, center = size / 2, radius = 100;
                const getCoords = (val, idx, total) => { const angle = Math.PI*2*idx/total - Math.PI/2; const r = (val/5)*radius; return {x: center + r*Math.cos(angle), y: center + r*Math.sin(angle)}; };
                let svg = `<svg width="100%" height="100%" viewBox="0 0 ${size} ${size}" class="overflow-visible">`;
                for (let i = 1; i <= 5; i++) {
                    const points = labels.map((_, idx) => { const {x,y} = getCoords(i, idx, labels.length); return `${x},${y}`; }).join(' ');
                    svg += `<polygon points="${points}" fill="none" stroke="${i===5?'#E2E8F0':'#F8FAFC'}" stroke-width="1"/>`;
                }
                labels.forEach((l, idx) => {
                    const outer = getCoords(5, idx, labels.length); const labelPos = getCoords(5.8, idx, labels.length);
                    svg += `<line x1="${center}" y1="${center}" x2="${outer.x}" y2="${outer.y}" stroke="#E2E8F0" stroke-width="1"/>`;
                    svg += `<text x="${labelPos.x}" y="${labelPos.y}" text-anchor="middle" dominant-baseline="middle" style="font-size:9px;font-weight:700;fill:#94a3b8;font-family:Instrument Sans">${l}</text>`;
                });
                svg += `<polygon id="chart-polygon" points="" fill="#D9EB31" fill-opacity="0.3" stroke="#475609" stroke-width="2"/>`;
                labels.forEach((_, idx) => { svg += `<circle id="chart-point-${idx}" cx="${center}" cy="${center}" r="3" fill="#FFFFFF" stroke="#475609" stroke-width="2"/>`; });
                svg += `</svg>`;
                document.getElementById('radar-chart').innerHTML = svg;
                this.updateChartVisuals(scores);
            }

            updateChartVisuals(scores) {
                const labels = ['Structure','Security','AI Gov','Commercial','Operations'];
                const size = 300, center = size/2, radius = 100;
                const getCoords = (val, idx, total) => { const angle = Math.PI*2*idx/total - Math.PI/2; const r = (val/5)*radius; return {x: center+r*Math.cos(angle), y: center+r*Math.sin(angle)}; };
                const pointsArr = Object.values(scores).map((s, idx) => getCoords(s, idx, labels.length));
                const poly = document.getElementById('chart-polygon');
                if (poly) poly.setAttribute('points', pointsArr.map(p=>`${p.x},${p.y}`).join(' '));
                pointsArr.forEach((p, idx) => { const pt = document.getElementById(`chart-point-${idx}`); if (pt) { pt.setAttribute('cx', p.x); pt.setAttribute('cy', p.y); } });
            }

            renderStats(scores) {
                const total = Object.values(scores).reduce((a,b)=>a+b,0);
                const pct = Math.min(100, Math.round(((total-5)/20)*100));
                document.getElementById('progress-text').innerText = `${pct}%`;
                document.getElementById('progress-bar').style.width = `${pct}%`;
                const avg = total / 5;
                const tierEl = document.getElementById('tier-badge');
                if (avg >= 4.5) { tierEl.innerText = "Enterprise ready"; tierEl.className = "px-3 py-1 rounded-sm font-bold text-xs border transition-all bg-[#ECF598] text-[#475609] border-[#475609]"; }
                else if (avg >= 3) { tierEl.innerText = "Growth stage"; tierEl.className = "px-3 py-1 rounded-sm font-bold text-xs border transition-all bg-white text-[#2B2A2A] border-[#2B2A2A]"; }
                else { tierEl.innerText = "Early stage"; tierEl.className = "px-3 py-1 rounded-sm font-bold text-xs border transition-all bg-white text-slate-500 border-slate-200"; }
            }

            renderBadges(scores) {
                const badges = [
                    { name: "Risk-proof", icon: ICONS.lock, earned: scores[1] >= 4 && scores[2] >= 4 },
                    { name: "Future ready", icon: ICONS.zapSm, earned: scores[3] >= 4 },
                    { name: "Commercial", icon: ICONS.briefcase, earned: scores[4] >= 4 },
                    { name: "Scale ops", icon: ICONS.trending, earned: scores[5] >= 4 }
                ];
                document.getElementById('badges-container').innerHTML = badges.map(b => `
                    <div class="p-3 rounded border flex flex-col items-center justify-center text-center transition-all ${b.earned ? 'border-slate-300 bg-[#F8F8F8] opacity-100' : 'border-dashed border-slate-200 opacity-40'}">
                        <span class="mb-1 ${!b.earned ? 'grayscale' : ''}">${b.icon}</span>
                        <span class="text-[10px] font-bold text-slate-600">${b.name}</span>
                        ${b.earned ? '<span class="text-[9px] bg-slate-200 text-slate-500 px-1.5 rounded mt-1">Pending review</span>' : ''}
                    </div>`).join('');

                const sectorBadgesWrapper = document.getElementById('sector-badges-wrapper');
                const sectorContainer = document.getElementById('sector-badges-container');
                let sectorHtml = '', hasSectors = false;
                Object.values(SECTOR_MODULES).forEach(mod => {
                    const ans = this.state.sectorAnswers[mod.id] || {};
                    const allReqMet = mod.items.every(item => !item.required || (ans[item.id] && this.state.uploads.has(item.docId)));
                    if (allReqMet) {
                        hasSectors = true;
                        const completedCount = mod.items.filter(item => ans[item.id] && this.state.uploads.has(item.docId)).length;
                        const completionPct = Math.round((completedCount/mod.items.length)*100);
                        const isGold = completedCount === mod.items.length;
                        sectorHtml += `<div class="p-3 rounded border flex flex-col gap-2 shadow-sm transition-all ${isGold?'bg-[#D9EB31] border-[#475609] text-[#2B2A2A]':'bg-white border-slate-200 text-slate-600'}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2"><span>${mod.icon}</span><span class="text-[10px] font-bold">${mod.badgeName}</span></div>
                                <span class="text-[9px] px-2 py-0.5 rounded font-bold uppercase tracking-wide ${isGold?'bg-white/60 text-[#475609] border border-[#475609]/20':'bg-slate-100 text-slate-500'}">${isGold?'Gold Standard':'Verified'}</span>
                            </div>
                            <div class="w-full ${isGold?'bg-[#475609]/20':'bg-slate-200'} rounded-full h-1.5 overflow-hidden">
                                <div class="${isGold?'bg-[#2B2A2A]':'bg-[#475609]'} h-full rounded-full transition-all duration-500" style="width:${completionPct}%"></div>
                            </div></div>`;
                    }
                });
                if (hasSectors) { sectorBadgesWrapper.classList.remove('hidden'); sectorContainer.innerHTML = sectorHtml; }
                else sectorBadgesWrapper.classList.add('hidden');
            }

            updateCoreProtocol() {
                document.getElementById('slide-counter').innerText = `${this.state.currentSlide+1} / ${CORE_DIMENSIONS.length}`;
                const dim = CORE_DIMENSIONS[this.state.currentSlide];
                const currentScore = this.state.targetValues[dim.id] || 1;
                let html = `<div class="flex flex-col md:flex-row h-full">
                    <div class="md:w-1/3 bg-[#F8F8F8] p-8 border-r border-slate-200 flex flex-col justify-between">
                        <div>
                            <div class="mb-4 bg-white w-16 h-16 flex items-center justify-center rounded-xl shadow-sm border border-slate-100 text-[#475609]">${dim.icon}</div>
                            <h3 class="text-xl font-bold text-[#2B2A2A] mb-2">${dim.title}</h3>
                            <p class="text-sm text-slate-500 font-medium mb-6">${dim.desc}</p>
                            <div class="bg-white p-4 rounded border border-slate-200">
                                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Rationale</h4>
                                <p class="text-xs text-slate-600 italic leading-relaxed">"${dim.rationale}"</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <span class="text-xs font-bold text-[#475609] uppercase">Current status</span>
                            <div class="flex items-center gap-2">
                                <div id="score-display-${dim.id}" class="text-3xl font-bold text-[#2B2A2A]">Level ${currentScore.toFixed(1)}</div>
                                <div id="warning-${dim.id}" class="hidden text-amber-500 font-bold text-xs uppercase tracking-wide flex items-center gap-1">${ICONS.alert} Requirements missing</div>
                            </div>
                        </div>
                    </div>
                    <div class="md:w-2/3 p-8 bg-white h-full overflow-y-auto no-scrollbar">
                        <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-2">
                            <h4 class="text-sm font-bold text-[#2B2A2A]">Evidence protocol</h4>
                            <button onclick="app.clearSlide(${dim.id})" class="text-xs text-slate-400 hover:text-red-500 font-medium">Clear</button>
                        </div>
                        <div class="space-y-6">${dim.items.map((item, idx) => this.renderProtocolItem(dim.id, item, idx)).join('')}</div>
                    </div>
                </div>`;
                document.getElementById('protocol-container').innerHTML = html;
                this.checkRequirements(dim.id);
            }

            renderProtocolItem(dimId, item, idx) {
                const val = this.state.answers[dimId]?.[idx] || 0;
                const selectedOptIndex = item.type === 'tiles' ? (this.state.selections[dimId]?.[idx] ?? -1) : -1;
                const isAnswered = (item.type === 'tiles' && selectedOptIndex !== -1) || (item.type !== 'tiles' && val > 0);
                const isUploaded = this.state.uploads.has(item.docId);
                const questionText = this.formatText(item.question);
                let inputHtml = '';
                if (item.type === 'tiles') {
                    inputHtml = `<div id="tiles-${dimId}-${idx}" class="flex gap-2 w-full mt-2">${item.options.map((opt, optIdx) => `<button onclick="app.handleAnswer(${dimId},${idx},${opt.v},${optIdx})" class="flex-1 py-2 px-3 rounded border text-xs ${selectedOptIndex===optIdx?'font-bold bg-[#ECF598] border-[#475609] text-[#2B2A2A]':'font-medium border-slate-200 text-slate-500 hover:border-slate-400 hover:bg-[#F8F8F8]'} transition-all">${this.formatText(opt.l)}</button>`).join('')}</div>`;
                } else {
                    inputHtml = `<div class="flex items-center gap-2 mt-1">
                        <label id="check-${dimId}-${idx}" class="flex items-center gap-2 cursor-pointer select-none" onclick="app.toggleCheck(${dimId},${idx})">
                            <div style="width:1.25rem;height:1.25rem;${val?'':'border:2px solid #cbd5e1;'}" class="w-5 h-5 flex-shrink-0 rounded border-2 flex items-center justify-center transition-all ${val?'bg-[#D9EB31] border-[#475609]':'border-slate-300 bg-white'}">${val?`<span class="text-[#475609]">${ICONS.check}</span>`:''}</div>
                            <span class="text-sm text-[#2B2A2A] font-medium">${questionText}</span>
                        </label>
                        <div class="text-slate-400 hover:text-fm-charcoal cursor-help transition-colors" onmouseenter="tooltip.show(event,'${item.why.replace(/'/g,"&#39;")}')" onmouseleave="tooltip.hide()">${ICONS.info}</div>
                    </div>`;
                }
                return `<div class="border-b border-slate-100 pb-4 last:border-0">
                    <div class="flex items-start gap-2 mb-1">
                        <div class="flex-grow">
                            ${item.type==='tiles'?`<div class="flex items-center gap-2"><span class="text-[10px] px-1.5 py-0.5 rounded font-bold tracking-wide ${item.required?'bg-[#2B2A2A] text-white':'bg-slate-200 text-slate-500'}">${item.required?'REQ':'OPT'}</span><span class="text-sm font-semibold text-[#2B2A2A]">${questionText}</span><div class="text-slate-400 hover:text-fm-charcoal cursor-help transition-colors" onmouseenter="tooltip.show(event,'${item.why.replace(/'/g,"&#39;")}')" onmouseleave="tooltip.hide()">${ICONS.info}</div></div>`:`<span class="text-[10px] px-1.5 py-0.5 rounded font-bold tracking-wide ${item.required?'bg-[#2B2A2A] text-white':'bg-slate-200 text-slate-500'}">${item.required?'REQ':'OPT'}</span>`}
                            ${inputHtml}
                        </div>
                    </div>
                    <div id="reveal-${dimId}-${idx}" class="overflow-hidden transition-all duration-300 ease-out pl-0 ${isAnswered?'max-h-[300px] opacity-100 mt-3 pt-3 border-t border-dashed border-slate-100':'max-h-0 opacity-0 pointer-events-none'}">
                        ${item.sub?`<div class="mb-3"><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Verification</p>${item.sub.map(s=>`<div class="flex items-center gap-2 mb-1"><div class="w-1.5 h-1.5 rounded-full bg-[#D9EB31]"></div><span class="text-xs text-slate-600">${s}</span></div>`).join('')}</div>`:''}
                        <div id="doc-warning-${dimId}-${idx}" class="${(val>0&&!isUploaded)?'':'hidden'} text-amber-600 text-[10px] font-bold mb-3 flex items-start gap-1.5 bg-amber-50 p-2 rounded border border-amber-200"><span class="mt-0.5">${ICONS.alert}</span><span>${item.required?'Document required to receive points for this item.':'Score halved until supporting document is linked.'}</span></div>
                        <button onclick="app.handleUpload('${item.docId}')" class="w-full py-2 rounded text-xs font-mono flex items-center justify-center gap-2 border transition-colors ${isUploaded?'bg-[#ECF598] border-[#475609] text-[#475609]':'bg-[#F8F8F8] border-dashed border-slate-200 text-slate-500 hover:border-[#475609]'}">${isUploaded?ICONS.check+' Linked':ICONS.upload+` Upload ${item.doc}`}</button>
                    </div>
                </div>`;
            }

            clearSlide(dimId) { this.state.answers[dimId] = {}; this.state.selections[dimId] = {}; this.updateAll(); }

            updateSectorView() {
                document.getElementById('sector-tabs').innerHTML = Object.values(SECTOR_MODULES).map(mod => `<button onclick="app.setSector('${mod.id}')" class="px-4 py-2 rounded text-xs font-bold border transition-colors ${this.state.currentSector===mod.id?'bg-[#D9EB31] border-[#D9EB31] text-[#475609]':'border-slate-600 hover:border-[#D9EB31] text-slate-300'}">${mod.title}</button>`).join('');
                const items = SECTOR_MODULES[this.state.currentSector].items;
                document.getElementById('sector-items').innerHTML = items.map(item => {
                    const hasValue = !!this.state.sectorAnswers[this.state.currentSector]?.[item.id];
                    const isUploaded = this.state.uploads.has(item.docId);
                    return `<div class="bg-white border border-slate-200 p-4 rounded hover:border-[#475609] transition-colors group flex flex-col gap-3 shadow-sm">
                        <div class="flex items-start justify-between gap-3 w-full">
                            <div class="flex items-center gap-3 flex-grow">
                                ${item.type==='checkbox'?`<label id="sec-check-${this.state.currentSector}-${item.id}" class="flex items-center gap-3 cursor-pointer select-none" onclick="app.toggleSectorCheck('${this.state.currentSector}','${item.id}')"><div style="width:1.25rem;height:1.25rem;${hasValue?'':'border:2px solid #cbd5e1;'}" class="w-5 h-5 flex-shrink-0 rounded border-2 flex items-center justify-center transition-all ${hasValue?'bg-[#D9EB31] border-[#475609]':'border-slate-300 bg-white'}">${hasValue?`<span class="text-[#475609]">${ICONS.check}</span>`:''}</div><div class="flex flex-col"><span class="text-[9px] font-bold ${item.required?'text-[#475609]':'text-slate-400'} uppercase tracking-wide leading-none mb-0.5">${item.required?'Required':'Optional'}</span><span class="text-sm text-[#2B2A2A] font-medium leading-tight">${this.formatText(item.question)}</span></div></label>`:`<div class="flex flex-col"><span class="text-[9px] font-bold ${item.required?'text-[#475609]':'text-slate-400'} uppercase tracking-wide leading-none mb-0.5">${item.required?'Required':'Optional'}</span><span class="text-sm text-[#2B2A2A] font-medium leading-tight">${this.formatText(item.question)}</span></div>`}
                                <div class="text-slate-400 hover:text-[#2B2A2A] cursor-help transition-colors flex-shrink-0" onmouseenter="tooltip.show(event,'${item.why.replace(/'/g,"&#39;")}')" onmouseleave="tooltip.hide()">${ICONS.info}</div>
                            </div>
                            <button onclick="app.handleUpload('${item.docId}')" class="text-[10px] px-3 py-1.5 rounded border border-dashed font-mono transition-all whitespace-nowrap flex-shrink-0 ${isUploaded?'bg-[#ECF598] border-[#475609] text-[#475609]':'border-slate-300 text-slate-500 hover:bg-[#F8F8F8] hover:border-[#475609] hover:text-[#475609]'}">${isUploaded?'✓ Linked':item.doc}</button>
                        </div>
                        ${item.type==='tiles'?`<div class="flex gap-2 w-full mt-1">${item.options.map((opt,optIdx)=>{const selIdx=this.state.sectorAnswers[this.state.currentSector]?.[item.id+'_opt']??-1;return`<button onclick="app.handleSectorTile('${this.state.currentSector}','${item.id}',${opt.v},${optIdx})" class="flex-1 py-2 px-3 rounded border text-xs ${selIdx===optIdx?'font-bold bg-[#ECF598] border-[#475609] text-[#2B2A2A]':'font-medium border-slate-200 text-slate-500 hover:border-slate-400 hover:bg-[#F8F8F8]'} transition-all">${this.formatText(opt.l)}</button>`;}).join('')}</div>`:''}
                        ${item.type==='text'?`<div class="mt-1 w-full"><input type="text" placeholder="${item.sub?item.sub[0]:'Enter value'}" value="${this.state.sectorAnswers[this.state.currentSector]?.[item.id]||''}" onchange="app.handleSectorText('${this.state.currentSector}','${item.id}',this.value)" class="w-full text-sm border border-slate-300 rounded p-2 focus:border-[#475609] focus:outline-none transition-colors"></div>`:''}
                        ${hasValue&&!isUploaded?`<div class="text-amber-600 text-[10px] font-bold flex items-center gap-1 mt-1 border-t border-dashed border-slate-200 pt-2">${ICONS.alert} ${item.required?'Document required for verification':'Document required for gold standard'}</div>`:''}
                    </div>`;
                }).join('');
            }

            updateDocButtons() {
                const info = REGISTRY_INFO[this.state.formData.country] || REGISTRY_INFO['uk'];
                const btn = document.getElementById('btn-doc_incorp');
                if (btn) this.renderDocButton(btn, 'doc_incorp', info.doc, this.state.uploads.has('doc_incorp'));
            }

            renderDocButton(el, docId, label, isUploaded) {
                if (isUploaded) { el.className = 'px-6 py-3 rounded text-xs font-mono flex items-center gap-2 w-full md:w-auto justify-center transition-all border bg-[#ECF598] border-[#475609] text-[#475609]'; el.innerHTML = ICONS.check + ' Certificate linked'; }
                else { el.className = 'px-6 py-3 rounded text-xs font-mono flex items-center gap-2 w-full md:w-auto justify-center transition-all border bg-[#F8F8F8] border-dashed border-slate-300 text-slate-500 hover:bg-white hover:border-[#475609]'; el.innerHTML = ICONS.upload + ` Upload ${label}`; }
            }
        }

        const tooltip = {
            show: (e, text) => { const el = document.getElementById('tooltip'); el.innerText = text; el.classList.add('visible'); el.style.left = (e.clientX+10)+'px'; el.style.top = (e.clientY+10)+'px'; },
            hide: () => { document.getElementById('tooltip').classList.remove('visible'); }
        };

        const app = new App();
        window.app = app;

        document.addEventListener('click', (e) => {
            const btn = document.getElementById('country-btn');
            const menu = document.getElementById('country-menu');
            if (btn && menu && !btn.contains(e.target) && !menu.contains(e.target)) menu.classList.add('hidden');
        });
    </script>
        </div>

        <!-- ================================================================ -->
        <!-- ADMIN VIEW                                                         -->
        <!-- ================================================================ -->
        <div id="Assessment-Admin" class="view-section w-full">
    <main class="flex-grow max-w-7xl mx-auto w-full grid lg:grid-cols-12 gap-6 relative">
        <aside class="lg:col-span-3 space-y-6">
            <div class="mb-2">
                <div class="text-xl font-bold tracking-tight text-fm-charcoal">Founders Match</div>
                <div class="text-sm font-medium text-slate-400">Assessment Admin</div>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Submissions</div><div class="text-3xl font-bold text-fm-charcoal" id="stat-total">0</div></div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Avg. Readiness</div><div class="text-3xl font-bold text-fm-charcoal" id="stat-avg">-</div></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-sm mb-4">Filter View</h3>
                <div class="space-y-3">
                    <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Sector</label><select id="filter-sector" onchange="adminRenderTable()" class="w-full text-sm border border-slate-300 rounded p-2 focus:border-fm-darkGreen focus:outline-none"><option value="all">All Sectors</option><option value="fin">Financial Services</option><option value="health">Healthcare</option><option value="gov">Public Sector</option><option value="retail">Retail</option><option value="aero">Aerospace & Defence</option><option value="sustainability">Sustainability</option></select></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Readiness Tier</label><select id="filter-tier" onchange="adminRenderTable()" class="w-full text-sm border border-slate-300 rounded p-2 focus:border-fm-darkGreen focus:outline-none"><option value="all">All Tiers</option><option value="high">Enterprise Ready (Avg 4+)</option><option value="med">Growth Stage (Avg 3-4)</option><option value="low">Early Stage (Avg &lt;3)</option></select></div>
                </div>
            </div>
            <div id="connection-status" class="text-xs font-medium text-slate-400 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-slate-300"></span> Ready</div>
        </aside>

        <section class="lg:col-span-9 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col min-h-[600px]">
            <div class="p-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                <h2 class="font-bold text-fm-charcoal">Submissions</h2>
                <div class="flex gap-2">
                    <input type="file" id="json-upload" accept=".json" class="hidden" onchange="adminHandleJsonUpload(this)">
                    <button onclick="document.getElementById('json-upload').click()" class="text-xs font-bold text-fm-charcoal hover:text-fm-darkGreen bg-white border border-slate-300 hover:bg-slate-50 px-3 py-1.5 rounded transition-colors flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Import JSON
                    </button>
                    <button onclick="window.refreshAdminData()" class="text-xs font-bold text-fm-boldGreen hover:text-fm-darkGreen bg-fm-charcoal hover:bg-fm-mediumCharcoal px-3 py-1.5 rounded transition-colors">Refresh</button>
                </div>
            </div>
            <div class="overflow-x-auto flex-grow">
                <table class="w-full text-sm text-left">
                    <thead class="bg-white text-slate-500 font-bold border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 w-48">Company</th>
                            <th class="px-6 py-4">Sector</th>
                            <th class="px-6 py-4">Date</th>
                            <th class="px-6 py-4">Readiness</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-table" class="divide-y divide-slate-50">
                        <tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">No submissions yet. Complete an assessment and click "Submit Assessment" to see results here.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Details Panel -->
    <div id="details-panel" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-fm-charcoal/20 backdrop-blur-sm" onclick="closeDetails()"></div>
        <div class="absolute inset-y-0 right-0 max-w-2xl w-full bg-white shadow-2xl transform transition-transform translate-x-full duration-300 ease-out flex flex-col" id="details-content">
            <div class="p-6 border-b border-slate-200 flex justify-between items-start bg-slate-50">
                <div>
                    <h2 class="text-2xl font-bold text-fm-charcoal" id="detail-company">Company Name</h2>
                    <div class="flex items-center gap-2 mt-2 text-sm text-slate-500">
                        <span id="detail-sector" class="px-2 py-0.5 rounded bg-white border border-slate-200 font-mono text-xs font-bold uppercase">SECTOR</span>
                        <span id="detail-reg">Reg: --</span>
                        <span>•</span>
                        <a href="#" id="detail-link" target="_blank" class="hover:text-fm-darkGreen hover:underline">Website ↗</a>
                    </div>
                </div>
                <button onclick="closeDetails()" class="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-8 space-y-8">
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-fm-taupe rounded-xl border border-slate-200"><div class="text-xs font-bold text-slate-500 uppercase mb-2">Overall Score</div><div class="text-4xl font-bold text-fm-charcoal" id="detail-score-avg">0.0</div><div class="text-sm font-medium mt-1" id="detail-tier-text">Tier</div></div>
                    <div class="p-4 bg-fm-taupe rounded-xl border border-slate-200"><div class="text-xs font-bold text-slate-500 uppercase mb-2">Documents</div><div class="text-4xl font-bold text-fm-charcoal" id="detail-doc-count">0</div><div class="text-sm font-medium text-slate-500 mt-1">Uploaded</div></div>
                </div>
                <div><h3 class="font-bold text-fm-charcoal border-b border-slate-200 pb-2 mb-4">Dimension Breakdown</h3><div class="space-y-3" id="detail-dimensions"></div></div>
                <div><h3 class="font-bold text-fm-charcoal border-b border-slate-200 pb-2 mb-4">Sector Mandates</h3><div class="bg-slate-50 rounded-xl p-4 border border-slate-100" id="detail-sector-answers"></div></div>
                <details class="group"><summary class="flex justify-between items-center font-bold text-xs uppercase text-slate-400 cursor-pointer hover:text-fm-darkGreen">View Raw JSON <span class="group-open:rotate-180 transition-transform">▼</span></summary><div class="mt-4 p-4 bg-slate-900 rounded-lg overflow-x-auto"><pre class="text-[10px] font-mono text-green-400" id="detail-json">{}</pre></div></details>
            </div>
            <div class="p-6 border-t border-slate-200 bg-white flex items-center justify-between">
                <p class="text-xs text-slate-400">Generate a full PDF-ready readiness report for this submission.</p>
                <button id="detail-report-btn" onclick="adminGenerateReport()" class="flex items-center gap-2 px-5 py-2.5 bg-fm-boldGreen text-fm-darkGreen border border-fm-darkGreen font-bold text-sm rounded-lg hover:bg-fm-darkGreen hover:text-white transition-all shadow-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    Generate Report
                </button>
            </div>
        </div>
    </div>

    <script>
        // Admin-scoped submissions array
        var adminSubmissions = [];

        function adminUpdateStats() {
            document.getElementById('stat-total').innerText = adminSubmissions.length;
            if (adminSubmissions.length === 0) { document.getElementById('stat-avg').innerText = '-'; return; }
            const totalScoreSum = adminSubmissions.reduce((acc, sub) => {
                const scores = Object.values(sub.scores || {});
                const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
                return acc + avg;
            }, 0);
            document.getElementById('stat-avg').innerText = (totalScoreSum/adminSubmissions.length).toFixed(1);
        }

        function adminRenderTable() {
            const tbody = document.getElementById('submissions-table');
            const sectorFilter = document.getElementById('filter-sector').value;
            const tierFilter = document.getElementById('filter-tier').value;
            let filtered = adminSubmissions.filter(sub => {
                if (sectorFilter !== 'all' && sub.selected_sector !== sectorFilter) return false;
                const scores = Object.values(sub.scores || {});
                const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : 0;
                if (tierFilter === 'high' && avg < 4) return false;
                if (tierFilter === 'med' && (avg < 3 || avg >= 4)) return false;
                if (tierFilter === 'low' && avg >= 3) return false;
                return true;
            });
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">No submissions found. Complete an assessment and click "Submit Assessment" to see results here.</td></tr>`;
                return;
            }
            tbody.innerHTML = filtered.map(sub => {
                const scores = Object.values(sub.scores || {});
                const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : '0.0';
                let tierClass = 'bg-slate-100 text-slate-500', tierLabel = 'Early Stage';
                if (avg >= 4) { tierClass = 'bg-[#ECF598] text-[#475609] border border-[#475609]/20'; tierLabel = 'Enterprise Ready'; }
                else if (avg >= 3) { tierClass = 'bg-white text-fm-charcoal border border-fm-charcoal'; tierLabel = 'Growth Stage'; }
                let date = 'N/A';
                if (sub.timestamp) { const ms = new Date(sub.timestamp).getTime(); if (!isNaN(ms)) date = new Date(ms).toLocaleDateString(); }
                const safeId = sub.id.replace(/['"]/g, '');
                return `<tr class="hover:bg-slate-50 group transition-colors cursor-pointer" onclick="adminOpenDetails('${safeId}')">
                    <td class="px-6 py-4 font-medium text-fm-charcoal">${sub.company_info?.name||'Unknown'}<div class="text-xs text-slate-400 font-normal mt-0.5">${sub.company_info?.website||''}</div></td>
                    <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-white border border-slate-200 text-slate-600 uppercase">${sub.selected_sector||'N/A'}</span></td>
                    <td class="px-6 py-4 text-slate-500 font-mono text-xs">${date}</td>
                    <td class="px-6 py-4"><div class="flex items-center gap-2"><span class="text-sm font-bold w-6 text-right">${avg}</span><div class="h-1.5 w-16 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-[#D9EB31]" style="width:${(avg/5)*100}%"></div></div></div><div class="text-[10px] text-slate-400 mt-1 uppercase font-bold">${tierLabel}</div></td>
                    <td class="px-6 py-4 text-right"><button class="text-slate-400 hover:text-fm-darkGreen transition-colors text-xs font-bold">View →</button></td>
                </tr>`;
            }).join('');
        }

        function adminOpenDetails(id) {
            const sub = adminSubmissions.find(s => s.id === id);
            if (!sub) return;
            const scores = Object.values(sub.scores || {});
            const avg = scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : '0.0';
            document.getElementById('detail-company').innerText = sub.company_info?.name || 'Unknown';
            document.getElementById('detail-sector').innerText = (sub.selected_sector||'N/A').toUpperCase();
            document.getElementById('detail-reg').innerText = `Reg: ${sub.company_info?.reg_no||'N/A'}`;
            const link = document.getElementById('detail-link');
            if (sub.company_info?.website) { link.href = sub.company_info.website.startsWith('http') ? sub.company_info.website : `https://${sub.company_info.website}`; link.classList.remove('hidden'); } else link.classList.add('hidden');
            document.getElementById('detail-score-avg').innerText = avg;
            document.getElementById('detail-doc-count').innerText = (sub.uploaded_documents||[]).length;
            document.getElementById('detail-tier-text').innerText = avg >= 4 ? '🟢 Enterprise Ready' : avg >= 3 ? '🟡 Growth Stage' : '🔴 Early Stage';
            const dimNames = {1:'Corporate Structure',2:'Security & Compliance',3:'AI Governance',4:'Commercial Readiness',5:'Operations'};
            document.getElementById('detail-dimensions').innerHTML = Object.entries(sub.scores||{}).map(([key,val])=>`<div class="flex items-center gap-4 text-sm"><div class="w-36 font-medium text-slate-600 truncate">${dimNames[key]||'Dim '+key}</div><div class="flex-grow bg-slate-100 rounded-full h-2 overflow-hidden"><div class="h-full bg-fm-charcoal" style="width:${(val/5)*100}%"></div></div><div class="w-12 text-right font-bold text-fm-charcoal">Lvl ${typeof val==='number'?val.toFixed(1):val}</div></div>`).join('');
            const sectorData = sub.sector_answers?.[sub.selected_sector]||{};
            const entries = Object.entries(sectorData).filter(([k])=>!k.endsWith('_opt'));
            document.getElementById('detail-sector-answers').innerHTML = entries.length === 0 ? '<span class="text-slate-400 text-xs italic">No sector data provided.</span>' : entries.map(([k,v])=>`<div class="flex justify-between items-center py-1 border-b border-slate-100 last:border-0"><span class="text-xs font-mono text-slate-500">${k}</span><span class="text-xs font-bold ${v?'text-fm-darkGreen':'text-slate-300'}">${v?'YES':'NO'}</span></div>`).join('');
            document.getElementById('detail-json').innerText = JSON.stringify(sub, null, 2);
            document.getElementById('detail-report-btn').setAttribute('data-sub-id', sub.id);
            const panel = document.getElementById('details-panel');
            const content = document.getElementById('details-content');
            panel.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-x-full'), 10);
        }

        function closeDetails() {
            const content = document.getElementById('details-content');
            content.classList.add('translate-x-full');
            setTimeout(() => document.getElementById('details-panel').classList.add('hidden'), 300);
        }

        function adminGenerateReport() {
            const btn = document.getElementById('detail-report-btn');
            const id = btn.getAttribute('data-sub-id');
            const sub = adminSubmissions.find(s => s.id === id);
            if (!sub) return;
            closeDetails();
            window.openReportForSubmission(sub);
        }

        window.refreshAdminData = async function() {
            document.getElementById('connection-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-400"></span> Loading...`;
            await window.loadSubmissions();
            adminSubmissions = [...window._submissionsStore];
            adminUpdateStats();
            adminRenderTable();
            document.getElementById('connection-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-[#D9EB31]"></span> ${adminSubmissions.length} submission${adminSubmissions.length!==1?'s':''} loaded`;
        };

        function adminHandleJsonUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    const newItems = Array.isArray(json) ? json : [json];
                    const normalized = newItems.map(item => ({ id: item.id || 'imported-' + Date.now() + Math.random().toString(36).substr(2,9), timestamp: item.timestamp || new Date().toISOString(), ...item }));
                    adminSubmissions = [...normalized, ...adminSubmissions];
                    // Also add to global store
                    normalized.forEach(s => window._submissionsStore.unshift(s));
                    adminUpdateStats();
                    adminRenderTable();
                } catch(err) { alert("Failed to parse JSON file."); }
                input.value = '';
            };
            reader.readAsText(file);
        }

        // Make renderTable accessible globally (used by filter selects)
        window.renderTable = adminRenderTable;

        // Initial load — run after DOM is ready
        (function initAdmin() {
            window.loadSubmissions().then(function() {
                adminSubmissions = [...window._submissionsStore];
                adminUpdateStats();
                adminRenderTable();
                document.getElementById('connection-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-[#D9EB31]"></span> ${adminSubmissions.length} submission${adminSubmissions.length!==1?'s':''} loaded`;
            });
        })();
    </script>
        </div>

        <!-- ================================================================ -->
        <!-- REPORT VIEW                                                        -->
        <!-- ================================================================ -->
        <div id="Assessment-Report" class="view-section w-full">

    <!-- Actions Bar -->
    <div class="max-w-[210mm] mx-auto mb-6 flex justify-between items-center no-print">
        <div class="flex items-center gap-3">
            <button onclick="switchView('Assessment-Admin')" class="text-xs font-medium text-slate-500 hover:text-fm-darkGreen flex items-center gap-1 transition-colors">← Back to Admin</button>
            <span class="text-slate-300">|</span>
            <div class="text-sm font-medium text-slate-500">Report Preview</div>
        </div>
        <div class="flex gap-3 items-center">
            <label class="px-4 py-2 text-xs font-bold border border-slate-300 rounded hover:bg-white hover:border-fm-darkGreen transition-colors flex items-center gap-2 cursor-pointer bg-white shadow-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <span>Upload JSON</span>
                <input type="file" id="jsonInput" accept=".json" class="hidden" onchange="reportHandleJsonUpload(event)">
            </label>
            <button type="button" id="btn-force-sterling" onclick="reportHandleGenerate(true)" class="px-4 py-2 text-xs font-bold border border-fm-boldGreen text-fm-darkGreen rounded hover:bg-fm-boldGreen hover:text-fm-charcoal transition-colors flex items-center gap-2 cursor-pointer bg-white shadow-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                Force Enterprise
            </button>
            <button type="button" id="btn-generate" onclick="reportHandleGenerate(false)" class="px-4 py-2 text-xs font-bold border border-slate-300 rounded hover:bg-white hover:border-fm-darkGreen transition-colors flex items-center gap-2 cursor-pointer bg-white shadow-sm">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
                Mock Data
            </button>
            <button type="button" onclick="window.print()" class="px-6 py-2 text-xs font-bold bg-fm-charcoal text-white rounded hover:bg-fm-boldGreen hover:text-fm-charcoal transition-colors flex items-center gap-2 cursor-pointer shadow-md">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Print
            </button>
        </div>
    </div>

    <!-- Report Container -->
    <div id="report-content" class="max-w-[210mm] mx-auto bg-white shadow-xl min-h-[297mm] print-container relative overflow-hidden">
        <div class="h-2 w-full bg-[#D9EB31]"></div>
        <div class="p-12">
            <header class="flex flex-col md:flex-row justify-between items-start mb-8 border-b border-slate-100 pb-6">
                <div class="mb-6 md:mb-0 w-full">
                    <div class="flex items-start gap-4 mb-2">
                        <div id="company-logo" class="w-16 h-16 rounded bg-[#F8F8F8] border border-slate-200 flex items-center justify-center text-2xl font-bold text-fm-charcoal tracking-tighter flex-shrink-0 mt-1">--</div>
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Readiness Profile</div>
                            <h1 class="text-4xl font-bold tracking-tight text-[#475609] leading-tight mb-3" id="company-name">Loading...</h1>
                            <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-slate-500 font-medium">
                                <div class="flex items-center gap-2"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span id="report-date">--</span></div>
                                <div class="flex items-center gap-2"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg><span id="company-reg">--</span></div>
                                <div class="flex items-center gap-2"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg><span id="company-location">--</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Badges -->
            <div class="mb-10 pb-6 border-b border-slate-100 grid grid-cols-2 gap-8 print-break-inside">
                <div><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Performance Capabilities</h4><div id="performance-badges-container" class="flex flex-wrap gap-2"></div></div>
                <div><h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Sector Verification</h4><div id="sector-badges-container" class="flex flex-wrap gap-2"></div></div>
            </div>

            <!-- Overall Readiness -->
            <section class="mb-10 print-break-inside">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Overall Readiness</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-[#F8F8F8] p-6 rounded-lg border border-slate-200 flex flex-col justify-between h-full">
                        <div class="flex justify-between items-start mb-4">
                            <div><div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Score</div><div class="flex items-end gap-2"><span id="total-score" class="text-5xl font-bold text-fm-charcoal">-</span><span class="text-lg font-medium text-slate-400 mb-1">/ 5.0</span></div></div>
                            <div id="tier-badge-container" class="text-right"></div>
                        </div>
                        <div class="mt-auto pt-4 relative pb-6">
                            <div class="h-3 bg-slate-200 rounded-full w-full relative overflow-hidden flex mt-2">
                                <div class="w-[60%] h-full bg-slate-300 border-r border-white"></div>
                                <div class="w-[24%] h-full bg-slate-400 border-r border-white"></div>
                                <div class="w-[16%] h-full bg-[#D9EB31]"></div>
                            </div>
                            <div id="barometer-marker" class="absolute top-2 w-0.5 h-7 bg-fm-charcoal z-10 transition-all duration-1000" style="left:0%"><div class="w-3 h-3 bg-fm-charcoal rounded-full -ml-[5px] -mt-1.5 border-2 border-white"></div></div>
                            <div id="tier-gap-text" class="text-[10px] font-bold text-fm-darkGreen mt-3 text-center bg-white/60 rounded py-1 border border-slate-200">Calculating...</div>
                        </div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-lg p-6 flex items-center justify-center h-full">
                        <div id="report-radar-chart" class="w-48 h-48"></div>
                    </div>
                </div>
                <div class="mb-8"><h3 class="text-sm font-bold text-fm-charcoal mb-3">Executive Summary</h3><div class="bg-white border border-slate-200 p-6 rounded-lg shadow-sm"><p id="exec-summary" class="text-sm text-slate-600 leading-relaxed text-justify">Analysis pending.</p></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-[#ECF598] border border-[#D9EB31] p-4 rounded-lg flex flex-col h-full"><h4 class="text-[10px] font-bold text-[#475609] uppercase tracking-widest mb-3 flex items-center gap-2"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>Key Strengths</h4><div id="strength-list" class="space-y-3"></div></div>
                    <div class="bg-red-50 border border-red-100 p-4 rounded-lg flex flex-col h-full"><h4 class="text-[10px] font-bold text-red-800 uppercase tracking-widest mb-3 flex items-center gap-2"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>Key Constraints</h4><div id="constraint-list" class="space-y-3"></div></div>
                </div>
            </section>

            <!-- Core Breakdown -->
            <div class="print-break-before"></div>
            <div class="flex items-center gap-3 mb-6 pt-8"><span class="w-1.5 h-6 bg-[#D9EB31] block"></span><h2 class="text-lg font-bold text-fm-charcoal">Core Protocols Breakdown</h2></div>
            <div class="grid grid-cols-2 gap-6 mb-10" id="core-grid"></div>

            <!-- Action Plan -->
            <div class="print-break-before"></div>
            <div class="flex items-center gap-3 mb-4 mt-8"><span class="w-1.5 h-6 bg-amber-400 block"></span><h2 class="text-lg font-bold text-fm-charcoal">Critical Action Plan</h2></div>
            <div class="mb-6 bg-slate-50 border border-slate-200 rounded p-4 text-xs text-slate-600 leading-relaxed flex gap-3 print-break-inside"><div class="flex-shrink-0 text-slate-400 mt-0.5"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></div><div><strong class="text-fm-charcoal block mb-1">Strategic Guidance</strong>This plan isolates commercial blockers. <strong>Mandatory</strong> items represent hard procurement gates that typically prevent contract signage. <strong>High Priority</strong> actions mitigate immediate deal-flow risks.</div></div>
            <div class="bg-white border border-slate-200 rounded-lg overflow-hidden mb-10 shadow-sm">
                <table class="w-full text-sm text-left">
                    <thead class="bg-[#F8F8F8] text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-200">
                        <tr><th class="px-6 py-3 w-1/3">Gap Identified</th><th class="px-6 py-3 w-1/4">Commercial Impact</th><th class="px-6 py-3 w-1/4">Required Action</th><th class="px-6 py-3 w-1/6 text-center">Type</th><th class="px-6 py-3 w-1/12">Priority</th></tr>
                    </thead>
                    <tbody id="action-table-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>

            <!-- Sector Specifics -->
            <div id="sector-section" class="mb-12 print-break-inside">
                <div class="flex items-center gap-3 mb-6"><span class="w-1.5 h-6 bg-slate-800 block"></span><h2 class="text-lg font-bold text-fm-charcoal">Sector Mandates</h2></div>
                <div class="space-y-6" id="sector-container"></div>
            </div>

            <!-- Footer -->
            <footer class="border-t border-slate-200 pt-8 mt-auto print-break-inside">
                <div class="flex justify-between items-end">
                    <div><div class="font-bold text-fm-charcoal text-sm">Founders Match</div><div class="text-xs text-slate-400 mt-1">Commercial Intent. Strategic Outcomes.</div></div>
                    <div class="text-right text-[10px] text-slate-400 max-w-xs leading-relaxed">This report is an automated readiness assessment. It does not constitute legal or financial advice.<br><span id="footer-timestamp" class="text-slate-300 italic">Generated: --</span></div>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // Report module — self-contained
        const REPORT_MOCK_COMPANIES = [
            { name:"Sterling FinTech Solutions", address:"1 Canada Square, London, E14 5AB", country:"United Kingdom", reg:"08889999", type:"perfect" },
            { name:"Acme Innovations Ltd", address:"123 Innovation Dr, London, EC2A 4NE", country:"United Kingdom", reg:"09876543", type:"random" },
            { name:"Nebula AI Systems", address:"Torstraße 15, Berlin, 10119", country:"Germany", reg:"HRB 54321", type:"random" },
            { name:"GreenFlow Dynamics", address:"Birger Jarlsgatan 2, Stockholm, 114 34", country:"Sweden", reg:"556000-1234", type:"random" },
            { name:"Quantum Ledger Inc", address:"450 Park Avenue South, New York, NY 10016", country:"USA", reg:"DE-8765432", type:"random" }
        ];

        const REPORT_SECTORS_DB = {
            fin: { name:"Financial Services", items:[{name:"FCA authorised",impact:"Regulatory Licence"},{name:"AML / KYC Framework",impact:"Financial Crime De-risking"},{name:"Consumer Duty Evidence",impact:"Retail Outcome Maturity"},{name:"PCI-DSS / PSD3 Compliance",impact:"Payments Standard"}] },
            health: { name:"Healthcare", items:[{name:"Caldicott Guardian",impact:"Patient Confidentiality"},{name:"Cyber Essentials",impact:"NHS Security Baseline"},{name:"FHIR / HL7 API",impact:"Clinical Interoperability"},{name:"DSPT Standards Exceeded",impact:"High-Tier Data Trust"}] },
            gov: { name:"Public Sector", items:[{name:"Cyber Essentials",impact:"Government Security Floor"},{name:"WCAG 2.1 AA",impact:"Accessibility Mandate"},{name:"Social Value Policy",impact:"Tender Scoring Baseline"},{name:"G-Cloud / DOS Framework",impact:"Procurement Shortcut"}] },
            retail: { name:"Retail", items:[{name:"Sedex / SMETA Audit",impact:"Ethical Sourcing"},{name:"GS1 GTIN Alignment",impact:"Product Identification"},{name:"Item-Level Traceability",impact:"Supply Chain Transparency"}] },
            aero: { name:"Aerospace & Defence", items:[{name:"AS9100 Certified",impact:"Aviation Quality Standard"},{name:"ITAR / EAR Compliant",impact:"Export Control"},{name:"JOSCAR Registered",impact:"Defence Pre-qualification"}] },
            sustainability: { name:"Sustainability", items:[{name:"Scope 1 & 2 Emissions Reported",impact:"Carbon Disclosure"},{name:"Climate Transition Plan",impact:"Net Zero Alignment"},{name:"Scope 3 Value Chain Data",impact:"Full Footprint Transparency"}] }
        };

        const REPORT_FINDINGS_DB = {
            corp: { high:["Robust corporate structure","Directors fully verified","Clean Cap Table"], low:["Unverified UBO / Directors","Missing Shareholders Agreement","Inadequate Indemnity Limit"] },
            sec:  { high:["SOC2 / ISO 27001 Certified","Pen-test < 6 months","MFA Enforced"], low:["No formal ISMS","Pen-test outdated (>12mo)","Disaster Recovery untested"] },
            ai:   { high:["EU AI Act Class defined","Human-in-the-loop active","Training data logged"], low:["Undefined Regulatory Tier","No 'Stop Button' protocol","Training data provenance gaps"] },
            comm: { high:["Healthy Runway (>18mo)","Enterprise MSA ready","References verified"], low:["Runway < 6 months","No Standard Rate Card","Liability caps undefined"] },
            ops:  { high:["SLA 99.9% supported","Incident Response Plan active","Dedicated Account Mgmt"], low:["Best-effort SLA only","No Incident Response Plan","Key-person dependency"] }
        };

        function reportGenerateMockData(forcePerfect) {
            let companyInfo;
            if (forcePerfect) {
                companyInfo = REPORT_MOCK_COMPANIES.find(c => c.type === 'perfect');
            } else {
                const randoms = REPORT_MOCK_COMPANIES.filter(c => c.type === 'random');
                companyInfo = randoms[Math.floor(Math.random() * randoms.length)];
            }
            let scores, sectorKey, sectorItems;
            if (forcePerfect) {
                scores = {corp:5.0, sec:5.0, ai:5.0, comm:5.0, ops:5.0};
                sectorKey = 'fin';
            } else {
                const profiles = ['early','growth','enterprise'];
                const profile = profiles[Math.floor(Math.random() * profiles.length)];
                const base = profile==='enterprise' ? 4.2 : profile==='growth' ? 3.2 : 2.0;
                const gs = () => Math.min(5, Math.max(1, base + (Math.random()*1.6-0.8)));
                scores = {corp:gs(), sec:gs(), ai:gs(), comm:gs(), ops:gs()};
                const sectorKeys = Object.keys(REPORT_SECTORS_DB);
                sectorKey = sectorKeys[Math.floor(Math.random() * sectorKeys.length)];
            }
            sectorItems = REPORT_SECTORS_DB[sectorKey].items.map(item => ({...item, status: forcePerfect || Math.random() > 0.35}));
            const scoreValues = Object.values(scores).map(s => parseFloat(s));
            const overall = (scoreValues.reduce((a,b)=>a+b,0)/scoreValues.length).toFixed(1);
            const data = {
                timestamp: new Date().toLocaleDateString('en-GB', {day:'numeric',month:'long',year:'numeric'}),
                company: companyInfo.name, location: companyInfo.address, country: companyInfo.country, reg: companyInfo.reg,
                overallScore: overall, scores: scores,
                sectors: [{name: REPORT_SECTORS_DB[sectorKey].name, items: sectorItems}]
            };
            reportEnrichData(data);
            return data;
        }

        function reportEnrichData(data) {
            const gaps = [];
            if (data.scores.comm < 3.5) gaps.push({area:"Commercial", issue:"Short Financial Runway", context:"Runway < 6 months signals potential insolvency risk.", impact:"Contract termination risk.", fix:"Secure bridge or escrow", priority:"High", req:"Mandatory"});
            if (data.scores.sec < 3.5) gaps.push({area:"Security", issue:"Missing ISO/SOC2", context:"Lack of independent security verification fails Vendor Risk Assessment.", impact:"Sales cycle block.", fix:"Initiate Type 1 Audit", priority:"High", req:"Mandatory"});
            if (data.scores.ai < 3.0) gaps.push({area:"AI", issue:"AI Act Unclassified", context:"Undefined regulatory tier creates unlimited liability exposure for the buyer.", impact:"Legal Compliance Block.", fix:"Complete Tier Assessment", priority:"High", req:"Mandatory"});
            if (data.scores.corp < 4.0) gaps.push({area:"Corporate", issue:"Insurance Limit Low", context:"Coverage is below standard enterprise indemnity thresholds.", impact:"Contract negotiation delay.", fix:"Increase PI/Cyber to £5m", priority:"Med", req:"Optional"});
            if (gaps.length === 0) gaps.push({area:"Operations", issue:"SLA Definition", context:"Undefined service levels create ambiguity.", impact:"Service Expectation Mismatch.", fix:"Formalize 99.9% Uptime SLA", priority:"Low", req:"Optional"});
            const strengthDescs = {corp:{title:"Structure",desc:"Clean legal setup minimizes liability."},sec:{title:"Security",desc:"High maturity defensive posture."},ai:{title:"AI Gov",desc:"Regulatory alignment de-risks deployment."},comm:{title:"Commercial",desc:"Enterprise-ready terms and runway."},ops:{title:"Operations",desc:"Support infrastructure built for scale."}};
            data.criticalGaps = gaps.slice(0,5);
            data.topStrengths = Object.keys(data.scores).filter(k=>data.scores[k]>=3.5).sort((a,b)=>data.scores[b]-data.scores[a]).slice(0,3).map(k=>({key:k,score:data.scores[k],...strengthDescs[k]}));
            data.topConstraints = Object.keys(data.scores).filter(k=>data.scores[k]<3.5).sort((a,b)=>data.scores[a]-data.scores[b]).slice(0,3).map(k=>({key:k,score:data.scores[k],...strengthDescs[k]}));
        }

        function reportHandleJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { try { processJsonData(JSON.parse(e.target.result)); } catch(err) { alert("Error parsing JSON: " + err.message); } };
            reader.readAsText(file);
        }

        // processJsonData exposed globally for Admin → Report handoff
        window.processJsonData = function(json) {
            const scores = {
                corp: parseFloat((json.scores||{})["1"]) || 2.5,
                sec:  parseFloat((json.scores||{})["2"]) || 2.5,
                ai:   parseFloat((json.scores||{})["3"]) || 2.5,
                comm: parseFloat((json.scores||{})["4"]) || 2.5,
                ops:  parseFloat((json.scores||{})["5"]) || 2.5
            };
            const overall = (Object.values(scores).reduce((a,b)=>a+b,0)/5).toFixed(1);
            const secKey = json.selected_sector || 'fin';
            const secDef = REPORT_SECTORS_DB[secKey] || REPORT_SECTORS_DB['fin'];
            const data = {
                timestamp: json.timestamp ? new Date(json.timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'}) : new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'}),
                company: json.company_info?.name || 'Unknown Company',
                location: json.company_info?.address ? [json.company_info.address.city, json.company_info.country].filter(Boolean).join(', ') : 'N/A',
                country: json.company_info?.country || 'N/A',
                reg: json.company_info?.reg_no || 'N/A',
                overallScore: overall,
                scores: scores,
                sectors: [{name: secDef.name, items: secDef.items.map(item=>({...item, status:true}))}]
            };
            reportEnrichData(data);
            reportRender(data);
        };

        function reportHandleGenerate(forcePerfect) {
            const btn = forcePerfect ? document.getElementById('btn-force-sterling') : document.getElementById('btn-generate');
            const orig = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><span>Loading...</span>';
            btn.disabled = true;
            setTimeout(() => {
                try { reportRender(reportGenerateMockData(forcePerfect)); }
                catch(e) { alert('Error: ' + e.message); }
                finally { btn.innerHTML = orig; btn.disabled = false; }
            }, 300);
        }

        function toggleDetails(id) {
            const el = document.getElementById(id);
            const btn = document.getElementById('btn-' + id);
            if (el.classList.contains('open')) { el.classList.remove('open'); if(btn) btn.innerHTML = `<span>▸</span> View Protocol Checklist`; }
            else { el.classList.add('open'); if(btn) btn.innerHTML = `<span>▾</span> Hide Protocol Checklist`; }
        }

        function reportRender(data) {
            const icons = window.ICONS || {};
            // Basic fields
            document.getElementById('report-date').innerText = data.timestamp;
            document.getElementById('company-name').innerText = data.company;
            document.getElementById('company-location').innerText = data.location;
            document.getElementById('company-reg').innerText = data.reg;
            document.getElementById('total-score').innerText = data.overallScore;
            document.getElementById('footer-timestamp').innerText = 'Generated: ' + new Date().toLocaleString();
            const initials = data.company.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
            document.getElementById('company-logo').innerText = initials;

            // Badges
            const perfBadges = [
                {name:"Risk-proof", icon:icons.lock||'', earned:data.scores.corp>=4&&data.scores.sec>=4},
                {name:"Future ready", icon:icons.zap||'', earned:data.scores.ai>=4},
                {name:"Commercial", icon:icons.briefcase||'', earned:data.scores.comm>=4},
                {name:"Scale ops", icon:icons.trending||'', earned:data.scores.ops>=4}
            ];
            const renderBadge = b => `<div class="px-2 py-1 rounded border flex items-center gap-1.5 transition-all ${b.earned?'bg-[#D9EB31] border-[#D9EB31] text-[#2B2A2A]':'bg-white border-dashed border-slate-200 text-slate-300'}"><span class="scale-75">${b.icon}</span><span class="text-[9px] font-bold uppercase tracking-wide">${b.name}</span></div>`;
            document.getElementById('performance-badges-container').innerHTML = perfBadges.map(renderBadge).join('');
            const sectorComplete = data.sectors.length > 0 && data.sectors[0].items.every(i=>i.status);
            document.getElementById('sector-badges-container').innerHTML = data.sectors.length > 0 ? `<div class="px-2 py-1 rounded border flex items-center gap-1.5 ${sectorComplete?'bg-[#D9EB31] border-[#D9EB31] text-[#2B2A2A]':'bg-white border-dashed border-slate-200 text-slate-400'}"><span class="text-[9px] font-bold uppercase tracking-wide">${data.sectors[0].name} ${sectorComplete?'Verified':'Pending'}</span></div>` : '<span class="text-slate-400 text-xs italic">No sector selected</span>';

            // Tier & Barometer
            const score = parseFloat(data.overallScore);
            let tierName = score >= 4.2 ? 'Enterprise Ready' : score >= 3.0 ? 'Growth Stage' : 'Early Stage';
            let gapMsg = score >= 4.2 ? 'Maximum Readiness Achieved' : score >= 3.0 ? `+${(4.2-score).toFixed(1)} pts to Enterprise Ready` : `+${(3.0-score).toFixed(1)} pts to Growth Stage`;
            document.getElementById('tier-badge-container').innerHTML = `<span class="inline-block px-3 py-1 rounded text-xs font-bold ${score>=4.2?'bg-[#D9EB31] text-[#475609] border border-[#475609]':'bg-slate-100 text-slate-500 border border-slate-200'}">${tierName}</span>`;
            document.getElementById('tier-gap-text').innerText = gapMsg;
            setTimeout(()=>{ const m=document.getElementById('barometer-marker'); if(m) m.style.left=(score/5*100)+'%'; }, 100);

            // Exec summary
            let summary = score>=4.2 ? `The entity demonstrates exceptional maturity (Score: ${data.overallScore}), qualifying as "Enterprise Ready." Primary recommendation is to maintain AI Act and DORA alignment as regulations evolve.`
                : score>=3.0 ? `Strong commercial potential but exhibits compliance gaps typical of the "Growth Stage" (Score: ${data.overallScore}). Attention is needed in formalizing Security (ISO/SOC2) documentation and commercial runway.`
                : `Current assessment (Score: ${data.overallScore}) indicates an "Early Stage" profile. Significant gaps in governance or security protocols present high risk for enterprise partners. Immediate remediation is required.`;
            document.getElementById('exec-summary').innerText = summary;

            // Strengths & Constraints
            const strHTML = data.topStrengths.length > 0 ? data.topStrengths.map((s,i) => i===0 ? `<div class="mb-2 pb-2 border-b border-[#D9EB31]/30"><div class="text-[9px] font-bold text-[#475609]/60 uppercase mb-0.5">Major Strength</div><div class="text-xs font-bold text-[#475609] leading-tight">High ${s.title}</div><div class="text-[9px] text-[#475609] leading-snug mt-0.5">${s.desc}</div></div>` : `<div class="flex items-center justify-between mt-1"><span class="text-[9px] font-bold text-[#475609]/50 uppercase">Minor</span><span class="text-[10px] font-medium text-[#475609]">${s.title} proven</span></div>`).join('') : '<div class="text-xs text-[#475609] italic">Developing strengths.</div>';
            document.getElementById('strength-list').innerHTML = strHTML;
            const conHTML = data.topConstraints.length > 0 ? data.topConstraints.map((c,i) => i===0 ? `<div class="mb-2 pb-2 border-b border-red-100"><div class="text-[9px] font-bold text-red-500 uppercase mb-0.5">Major Constraint</div><div class="text-xs font-bold text-red-900 leading-tight">Low ${c.title} Maturity</div><div class="text-[9px] text-red-700 leading-snug mt-0.5">Score: ${typeof c.score==='number'?c.score.toFixed(1):c.score} — requires immediate focus.</div></div>` : `<div class="flex items-center justify-between mt-1"><span class="text-[9px] font-bold text-red-400 uppercase">Minor</span><span class="text-[10px] font-medium text-red-800">${c.title} gap</span></div>`).join('') : '<div class="text-xs text-[#475609] italic">No critical constraints identified.</div>';
            document.getElementById('constraint-list').innerHTML = conHTML;

            // Core Cards
            const dims = [
                {id:'corp', title:'Corporate Structure', desc:'Legal & Financial Foundation'},
                {id:'sec', title:'Security & Compliance', desc:'Data Protection & ISO'},
                {id:'ai', title:'AI Governance', desc:'EU AI Act Alignment'},
                {id:'comm', title:'Commercial', desc:'Enterprise Sales Readiness'},
                {id:'ops', title:'Operations', desc:'Resilience & Support'}
            ];
            document.getElementById('core-grid').innerHTML = dims.map(dim => {
                const dimScore = parseFloat(data.scores[dim.id]).toFixed(1);
                const pct = (dimScore/5)*100;
                const barColor = dimScore >= 3.5 ? 'bg-[#D9EB31]' : dimScore >= 2.5 ? 'bg-amber-400' : 'bg-red-400';
                const findings = parseFloat(dimScore) >= 3.5 ? REPORT_FINDINGS_DB[dim.id].high : REPORT_FINDINGS_DB[dim.id].low;
                return `<div class="bg-white border border-slate-200 p-5 rounded-lg protocol-card shadow-sm flex flex-col h-full">
                    <div class="flex justify-between items-start mb-3"><div><h3 class="font-bold text-fm-charcoal text-sm">${dim.title}</h3><div class="text-[10px] text-slate-500 uppercase tracking-wide mt-0.5">${dim.desc}</div></div><div class="text-xl font-bold text-fm-charcoal">${dimScore}</div></div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mb-4"><div class="${barColor} h-full" style="width:${pct}%"></div></div>
                    <div class="mb-4"><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Key Findings</h4><ul class="space-y-1">${findings.slice(0,2).map(f=>`<li class="text-xs text-slate-600 flex items-start gap-1.5"><div class="w-1 h-1 rounded-full bg-slate-400 mt-1.5 flex-shrink-0"></div>${f}</li>`).join('')}</ul></div>
                    <div class="mt-auto pt-3 border-t border-slate-100">
                        <button type="button" id="btn-details-${dim.id}" onclick="toggleDetails('details-${dim.id}')" class="accordion-btn text-[10px] font-bold text-[#475609] hover:underline w-full text-left outline-none flex items-center gap-1 cursor-pointer"><span>▸</span> View Checklist</button>
                        <div id="details-${dim.id}" class="accordion-content mt-2 space-y-1 bg-slate-50 p-2 rounded custom-scrollbar overflow-y-auto">
                            ${['Pass','Pass','Needs Review','Pending','Pass','In Progress'].map((status,i)=>`<div class="flex justify-between items-center text-xs border-b border-slate-100 last:border-0 py-1.5"><span class="text-slate-600 leading-tight">Requirement ${i+1}</span><span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${status==='Pass'?'bg-[#D9EB31] text-[#475609]':status==='Needs Review'?'bg-amber-100 text-amber-700':'bg-slate-200 text-slate-500'}">${status}</span></div>`).join('')}
                        </div>
                    </div>
                </div>`;
            }).join('');

            // Action Plan
            if (data.criticalGaps.length === 0) {
                document.getElementById('action-table-body').innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-500 italic">No critical gaps identified. Enterprise ready!</td></tr>`;
            } else {
                document.getElementById('action-table-body').innerHTML = data.criticalGaps.map(gap => `<tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0">
                    <td class="px-6 py-3"><div class="font-bold text-fm-charcoal text-xs">${gap.issue}</div><div class="text-[10px] text-slate-400 mt-1 italic leading-tight">${gap.context}</div></td>
                    <td class="px-6 py-3 text-xs text-slate-600">${gap.impact}</td>
                    <td class="px-6 py-3 text-xs text-slate-600 font-mono bg-slate-50 rounded">${gap.fix}</td>
                    <td class="px-6 py-3 text-center"><span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${gap.req==='Mandatory'?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'}">${gap.req}</span></td>
                    <td class="px-6 py-3 text-xs ${gap.priority==='High'?'text-red-600 font-bold':gap.priority==='Med'?'text-amber-600 font-bold':'text-slate-600'}">${gap.priority}</td>
                </tr>`).join('');
            }

            // Sectors
            document.getElementById('sector-container').innerHTML = data.sectors.map(sec => `
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 transition-colors protocol-card">
                    <h3 class="text-sm font-bold text-fm-charcoal mb-3">${sec.name} Protocols</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${sec.items.map(item=>`<div class="p-3 border rounded flex items-center justify-between ${item.status?'bg-white border-slate-200 shadow-sm':'bg-white border-dashed border-red-200'}">
                            <div class="overflow-hidden"><div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full ${item.status?'bg-[#D9EB31]':'bg-red-400'} flex-shrink-0"></div><span class="text-xs font-bold text-fm-charcoal truncate">${item.name}</span></div><div class="text-[10px] text-slate-500 pl-4 truncate">${item.impact}</div></div>
                            <div class="text-[9px] font-bold ${item.status?'text-[#475609]':'text-red-500'} ml-2">${item.status?'OK':'MISSING'}</div>
                        </div>`).join('')}
                    </div>
                </div>`).join('');

            // Radar Chart
            const values = Object.values(data.scores).map(s=>parseFloat(s));
            const rLabels = ['Corp','Sec','AI','Comm','Ops'];
            const rSize=160, rCenter=rSize/2, rRadius=65;
            let rSvg = `<svg width="100%" height="100%" viewBox="0 0 ${rSize} ${rSize}" class="overflow-visible">`;
            for (let i=1; i<=4; i++) {
                const r = (i/4)*rRadius;
                const pts = rLabels.map((_,idx)=>{const a=Math.PI*2*idx/rLabels.length-Math.PI/2;return`${rCenter+r*Math.cos(a)},${rCenter+r*Math.sin(a)}`;}).join(' ');
                rSvg += `<polygon points="${pts}" fill="none" stroke="#E2E8F0" stroke-width="1"/>`;
            }
            const dPts = values.map((v,idx)=>{const a=Math.PI*2*idx/rLabels.length-Math.PI/2;const r=(v/5)*rRadius;return{x:rCenter+r*Math.cos(a),y:rCenter+r*Math.sin(a)};});
            rSvg += `<polygon points="${dPts.map(p=>`${p.x},${p.y}`).join(' ')}" fill="#D9EB31" fill-opacity="0.5" stroke="#475609" stroke-width="2"/>`;
            rLabels.forEach((l,idx)=>{const a=Math.PI*2*idx/rLabels.length-Math.PI/2;const r=rRadius+15;rSvg+=`<text x="${rCenter+r*Math.cos(a)}" y="${rCenter+r*Math.sin(a)}" text-anchor="middle" dominant-baseline="middle" style="font-size:8px;font-weight:700;fill:#94a3b8;font-family:Instrument Sans">${l}</text>`;});
            rSvg += `</svg>`;
            document.getElementById('report-radar-chart').innerHTML = rSvg;
        }

        // Auto-initialize report with mock data immediately (no DOMContentLoaded needed — script runs at end of body)
        (function initReport() {
            try {
                reportRender(reportGenerateMockData(false));
            } catch(e) {
                console.error('Report init error:', e);
                document.getElementById('company-name').innerText = 'Click "Mock Data" to generate a sample report';
            }
        })();
    </script>
        </div>

    </main>

    <script>
        // Final init
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });
    </script>
</body>
</html>